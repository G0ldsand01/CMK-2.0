---
import { and, eq } from 'drizzle-orm';
import { cartTable, imageTable, productImageTable, productsTable } from '@/db/schema';
import db from '@/lib/db';
import InternalCart from './InternalCart';

interface Props {
	classes?: string;
	variant?:
		| 'outline'
		| 'default'
		| 'secondary'
		| 'ghost'
		| 'link'
		| 'destructive';
}

const { classes, variant } = Astro.props;

const user = Astro.locals.user;

// Load cart items with product images (empty if user not authenticated)
let cart: Array<{
	cart: typeof cartTable.$inferSelect;
	products: typeof productsTable.$inferSelect;
	image: string | null;
}> = [];

if (user) {
	const cartItems = await db
		.select({
			cart: cartTable,
			products: productsTable,
		})
		.from(cartTable)
		.where(eq(cartTable.userId, user.id))
		.innerJoin(productsTable, eq(cartTable.productId, productsTable.id));

	// Load images for each product
	cart = await Promise.all(
		cartItems.map(async (item) => {
			const [firstImage] = await db
				.select({
					image: imageTable,
				})
				.from(productImageTable)
				.where(eq(productImageTable.productId, item.products.id))
				.leftJoin(imageTable, eq(productImageTable.image, imageTable.id))
				.orderBy(productImageTable.priority)
				.limit(1);

			return {
				...item,
				image: firstImage?.image?.image || null,
			};
		})
	);
}
---
<InternalCart newCart={cart} client:load classes={classes} variant={variant}>
	<slot/>
</InternalCart>
