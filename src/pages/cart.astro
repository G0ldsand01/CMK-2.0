---
import { eq } from 'drizzle-orm';
import { ShoppingBag, ShoppingCart } from 'lucide-react';
import FullPageCart from '@/components/cart/FullPageCart';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { cartTable, imageTable, productImageTable, productsTable } from '@/db/schema';
import Layout from '@/layouts/Layout.astro';
import db from '@/lib/db';

const getCurrentUser = () => {
	if (Astro.locals.user) {
		return Astro.locals.user;
	} else {
		// Redirect to login page if the user is not authenticated
		const currentUrl = Astro.url.pathname + Astro.url.search;
		Astro.redirect(`/login?redirect=${encodeURIComponent(currentUrl)}`);
		return null;
	}
};

const user = await getCurrentUser();
if (!user) {
	const currentUrl = Astro.url.pathname + Astro.url.search;
	return Astro.redirect(`/login?redirect=${encodeURIComponent(currentUrl)}`);
}

// Load cart items with product images
const cartItems = await db
	.select({
		cart: cartTable,
		products: productsTable,
	})
	.from(cartTable)
	.where(eq(cartTable.userId, user.id))
	.innerJoin(productsTable, eq(cartTable.productId, productsTable.id));

// Load images for each product
const cart = await Promise.all(
	cartItems.map(async (item) => {
		const [firstImage] = await db
			.select({
				image: imageTable,
			})
			.from(productImageTable)
			.where(eq(productImageTable.productId, item.products.id))
			.leftJoin(imageTable, eq(productImageTable.image, imageTable.id))
			.orderBy(productImageTable.priority)
			.limit(1);

		return {
			...item,
			image: firstImage?.image?.image || null,
		};
	})
);
---
<Layout title="Your Cart" navbar={true} cart={false}>
	<main class="max-w-6xl mx-auto px-4 py-8 mt-25">
		<div class="space-y-6">
			{/* Header */}
			<div class="text-center space-y-2">
				<h1 class="text-4xl font-bold tracking-tight">Your Cart</h1>
				<p class="text-muted-foreground text-lg">
					Review your items and proceed to checkout
				</p>
			</div>

			{/* Cart Content */}
			{cart.length === 0 ? (
				<Card>
					<CardContent className="flex flex-col items-center justify-center py-16">
						<ShoppingCart className="size-20 text-muted-foreground mb-6" />
						<h2 class="text-2xl font-semibold mb-2">Your cart is empty</h2>
						<p class="text-muted-foreground text-center mb-8 max-w-md">
							Looks like you haven't added any items to your cart yet. Start shopping to fill it up!
						</p>
						<a href="/products">
							<Button variant="default" size="lg" className="gap-2">
								<ShoppingBag className="size-5" />
								Continue Shopping
							</Button>
						</a>
					</CardContent>
				</Card>
			) : (
				<FullPageCart newCart={cart} client:load />
			)}
		</div>
	</main>
</Layout>
