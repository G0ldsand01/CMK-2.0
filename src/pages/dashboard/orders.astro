---
import { eq, desc } from 'drizzle-orm';
import { ordersTable, productsTable, threeDPrintOrdersTable } from '@/db/schema';
import DashboardLayout from '@/layouts/DashboardLayout.astro';
import { getCurrentUser } from '@/lib/auth-server';
import db from '@/lib/db';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Package, Calendar, DollarSign, CheckCircle2, Clock, XCircle, AlertCircle, Download } from 'lucide-react';

const user = await getCurrentUser(Astro.request);

if (!user) {
  return Astro.redirect('/login');
}

// Récupérer les commandes normales de l'utilisateur
const normalOrders = await db
  .select()
  .from(ordersTable)
  .where(eq(ordersTable.userId, user.id))
  .orderBy(desc(ordersTable.createdAt));

// Récupérer les commandes 3D de l'utilisateur (par email) - avec gestion d'erreur
let threeDOrders = [];
try {
  threeDOrders = await db
    .select()
    .from(threeDPrintOrdersTable)
    .where(eq(threeDPrintOrdersTable.customerEmail, user.email))
    .orderBy(desc(threeDPrintOrdersTable.createdAt));
} catch (error) {
  console.warn('⚠️ Table 3dprint_orders does not exist yet. Run migration first:', error);
  // La table n'existe pas encore, on continue avec les commandes normales seulement
}

// Helper function to calculate order total
const calculateOrderTotal = (cartJSON: any[]) => {
  if (!Array.isArray(cartJSON)) return 0;
  return cartJSON.reduce(
    (acc, item) => acc + Number(item.products?.price || 0) * (item.cart?.quantity || 0),
    0
  );
};

// Helper function to get status badge
const getStatusBadge = (status: string) => {
  const statusLower = status.toLowerCase();
  if (statusLower === 'completed' || statusLower === 'paid') {
    return { variant: 'default' as const, icon: CheckCircle2, label: 'Completed' };
  } else if (statusLower === 'pending' || statusLower === 'processing') {
    return { variant: 'secondary' as const, icon: Clock, label: 'Pending' };
  } else if (statusLower === 'cancelled' || statusLower === 'refunded') {
    return { variant: 'destructive' as const, icon: XCircle, label: status };
  } else {
    return { variant: 'outline' as const, icon: AlertCircle, label: status };
  }
};

// Helper function to count items in order
const countOrderItems = (cartJSON: any[]) => {
  if (!Array.isArray(cartJSON)) return 0;
  return cartJSON.reduce((acc, item) => acc + (item.cart?.quantity || 0), 0);
};
---

<DashboardLayout
  title="My Orders"
  breadcrumb={{
    '/orders': 'My Orders',
  }}
>
  <div class="space-y-6 p-6">
    <div class="space-y-2">
      <h1 class="text-3xl font-bold tracking-tight">My Orders</h1>
      <p class="text-muted-foreground">
        View and track all your orders
      </p>
    </div>

    {normalOrders.length === 0 && threeDOrders.length === 0 ? (
      <Card>
        <CardContent class="flex flex-col items-center justify-center py-16">
          <Package class="size-16 text-muted-foreground mb-4" />
          <h3 class="text-lg font-semibold mb-2">No orders yet</h3>
          <p class="text-muted-foreground text-center mb-6">
            When you place an order, it will appear here.
          </p>
          <a
            href="/products"
            class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors h-9 px-4 py-2 bg-primary text-primary-foreground shadow-xs hover:bg-primary/90"
          >
            Start Shopping
          </a>
        </CardContent>
      </Card>
    ) : (
      <div class="space-y-4">
        {/* Commandes normales */}
        {normalOrders.map((order) => {
          const total = calculateOrderTotal(order.cartJSON);
          const itemCount = countOrderItems(order.cartJSON);
          const statusInfo = getStatusBadge(order.status);
          const StatusIcon = statusInfo.icon;
          
          return (
            <Card key={`normal-${order.id}`} class="hover:shadow-lg transition-shadow">
              <CardHeader>
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                  <div class="space-y-1">
                    <div class="flex items-center gap-2">
                      <CardTitle class="text-xl">Order #{order.id}</CardTitle>
                      <Badge variant={statusInfo.variant} class="flex items-center gap-1">
                        <StatusIcon class="size-3" />
                        {statusInfo.label}
                      </Badge>
                    </div>
                    <CardDescription class="flex items-center gap-2">
                      <Calendar class="size-4" />
                      {new Date(order.createdAt).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                      })}
                    </CardDescription>
                  </div>
                  <div class="flex items-center gap-2 text-lg font-semibold">
                    <DollarSign class="size-5" />
                    {total.toFixed(2)} CAD
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                <div class="space-y-4">
                  <div class="flex items-center gap-2 text-sm text-muted-foreground">
                    <Package class="size-4" />
                    <span>{itemCount} item{itemCount !== 1 ? 's' : ''}</span>
                  </div>
                  
                  {Array.isArray(order.cartJSON) && order.cartJSON.length > 0 && (
                    <div class="space-y-2">
                      <h4 class="text-sm font-medium">Items:</h4>
                      <div class="space-y-2">
                        {order.cartJSON.slice(0, 3).map((item: any, idx: number) => (
                          <div class="flex items-center justify-between text-sm p-2 rounded-md bg-muted/50">
                            <span class="flex-1">
                              {item.products?.name || `Item ${idx + 1}`}
                            </span>
                            <span class="text-muted-foreground">
                              Qty: {item.cart?.quantity || 0}
                            </span>
                            {item.products?.price && (
                              <span class="ml-4 font-medium">
                                ${(Number(item.products.price) * (item.cart?.quantity || 0)).toFixed(2)}
                              </span>
                            )}
                          </div>
                        ))}
                        {order.cartJSON.length > 3 && (
                          <p class="text-sm text-muted-foreground text-center pt-2">
                            +{order.cartJSON.length - 3} more item{order.cartJSON.length - 3 !== 1 ? 's' : ''}
                          </p>
                        )}
                      </div>
                    </div>
                  )}
                  
                  <div class="pt-4 border-t">
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-muted-foreground">Stripe Session ID:</span>
                      <code class="text-xs bg-muted px-2 py-1 rounded">{order.stripeSessionId}</code>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          );
        })}

        {/* Commandes 3D */}
        {threeDOrders.map((order) => {
          const statusInfo = getStatusBadge(order.status);
          const StatusIcon = statusInfo.icon;
          const total = Number(order.price);
          
          return (
            <Card key={`3d-${order.id}`} class="hover:shadow-lg transition-shadow border-l-4 border-l-primary">
              <CardHeader>
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                  <div class="space-y-1">
                    <div class="flex items-center gap-2">
                      <CardTitle class="text-xl">3D Print Order #{order.id}</CardTitle>
                      <Badge variant={statusInfo.variant} class="flex items-center gap-1">
                        <StatusIcon class="size-3" />
                        {statusInfo.label}
                      </Badge>
                    </div>
                    <CardDescription class="flex items-center gap-2">
                      <Calendar class="size-4" />
                      {new Date(order.createdAt).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                      })}
                    </CardDescription>
                  </div>
                  <div class="flex items-center gap-2 text-lg font-semibold">
                    <DollarSign class="size-5" />
                    {total.toFixed(2)} CAD
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                <div class="space-y-4">
                  <div class="p-3 rounded-md bg-muted/50">
                    <div class="space-y-2 text-sm">
                      <p><strong>File:</strong> {order.filename}</p>
                      <p><strong>Material:</strong> {order.material} - {order.color}</p>
                      {order.infill && <p><strong>Infill:</strong> {order.infill}%</p>}
                      {order.printer && <p><strong>Printer:</strong> {order.printer}</p>}
                      {order.volumeCm3 && <p><strong>Volume:</strong> {Number(order.volumeCm3).toFixed(1)} cm³</p>}
                      {order.notes && (
                        <p class="mt-2 pt-2 border-t"><strong>Notes:</strong> {order.notes}</p>
                      )}
                    </div>
                  </div>
                  
                  {order.fileUrl && (
                    <div class="pt-2 border-t">
                      <a 
                        href={order.fileUrl} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-2 text-sm text-primary hover:underline font-medium"
                      >
                        <Download class="size-4" />
                        Download 3D Model
                      </a>
                    </div>
                  )}
                  
                  <div class="pt-4 border-t">
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-muted-foreground">Stripe Session ID:</span>
                      <code class="text-xs bg-muted px-2 py-1 rounded">{order.stripeSessionId}</code>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          );
        })}
      </div>
    )}
  </div>
</DashboardLayout>
