---
import { CDN_URL } from 'astro:env/client';
import { eq, inArray } from 'drizzle-orm';
import { 
  AlertCircle,
  ArrowLeft, 
  Calendar, 
  CheckCircle2, 
  Clock, 
  DollarSign, 
  Download,
  Package, 
  RefreshCw, 
  XCircle,
} from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { 
  imageTable, 
  ordersTable, 
  productImageTable,
  productsTable, 
  user as userTable,
} from '@/db/schema';
import AdminDashboardLayout from '@/layouts/AdminDashboardLayout.astro';
import { getCurrentUser } from '@/lib/auth-server';
import { stripe } from '@/lib/stripe';
import db from '@/lib/db';

const currentUser = await getCurrentUser(Astro.request);
if (!currentUser || currentUser.role !== 'admin') {
  return Astro.redirect('/login');
}

const { id } = Astro.params;

const [order] = await db
  .select({
    id: ordersTable.id,
    status: ordersTable.status,
    cartJSON: ordersTable.cartJSON,
    createdAt: ordersTable.createdAt,
    userId: ordersTable.userId,
    stripeSessionId: ordersTable.stripeSessionId,
  })
  .from(ordersTable)
  .where(eq(ordersTable.id, Number(id)));

if (!order) {
  return Astro.redirect('/dashboard/admin/orders');
}

// Récupérer les métadonnées de la session Stripe pour obtenir le lien de téléchargement
let downloadUrl: string | null = null;
try {
  const session = await stripe.checkout.sessions.retrieve(order.stripeSessionId);
  downloadUrl = session.metadata?.file_url || session.metadata?.download_url || null;
} catch (error) {
  console.error('Error retrieving Stripe session:', error);
}

// Get user info
const orderUser = await db
  .select({
    id: userTable.id,
    name: userTable.name,
    email: userTable.email,
  })
  .from(userTable)
  .where(eq(userTable.id, order.userId))
  .limit(1);

// Extract product IDs
const productIds = order.cartJSON.map((item) => item.products.id);
const products = await db
  .select()
  .from(productsTable)
  .where(inArray(productsTable.id, productIds));

// Load images for each product
const orderItemsWithImages = await Promise.all(
  order.cartJSON.map(async (item) => {
    const product = products.find((p) => p.id === item.products.id);
    if (!product) return null;

    const [firstImage] = await db
      .select({
        image: imageTable,
      })
      .from(productImageTable)
      .where(eq(productImageTable.productId, product.id))
      .leftJoin(imageTable, eq(productImageTable.image, imageTable.id))
      .orderBy(productImageTable.priority)
      .limit(1);

    return {
      ...item,
      product,
      image: firstImage?.image?.image || null,
    };
  })
);

const orderItems = orderItemsWithImages.filter((item) => item !== null);

const totalPrice = orderItems.reduce((sum, item) => {
  return sum + (Number(item.product?.price) || 0) * item.cart.quantity;
}, 0);

// Helper function to get status badge
const getStatusBadge = (status: string) => {
  const statusLower = status.toLowerCase();
  if (statusLower === 'completed' || statusLower === 'paid') {
    return { variant: 'default' as const, icon: CheckCircle2, label: 'Completed' };
  } else if (statusLower === 'pending' || statusLower === 'processing') {
    return { variant: 'secondary' as const, icon: Clock, label: 'Pending' };
  } else if (statusLower === 'cancelled') {
    return { variant: 'destructive' as const, icon: XCircle, label: 'Cancelled' };
  } else if (statusLower === 'refunded') {
    return { variant: 'outline' as const, icon: RefreshCw, label: 'Refunded', className: 'border-yellow-500 text-yellow-500' };
  } else {
    return { variant: 'outline' as const, icon: AlertCircle, label: status };
  }
};

const statusInfo = getStatusBadge(order.status);
const StatusIcon = statusInfo.icon;
---

<AdminDashboardLayout
  title={`Order #${id}`}
  breadcrumb={{
    '/orders': 'Manage Orders',
    [`/order/${id}`]: `Order #${id}`,
  }}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 sm:py-8 pt-20 sm:pt-30">
    {/* Header */}
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 sm:gap-0 mb-4 sm:mb-6">
      <div class="space-y-2 flex-1 min-w-0">
        <div class="flex flex-wrap items-center gap-2 sm:gap-3">
          <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Order #{order.id}</h1>
          <Badge variant={statusInfo.variant} class={`flex items-center gap-1.5 text-xs sm:text-sm ${statusInfo.className || ''}`}>
            <StatusIcon class="size-3" />
            {statusInfo.label}
          </Badge>
        </div>
        <p class="text-muted-foreground text-sm sm:text-lg">
          View order details and manage order status
        </p>
      </div>
      <a href="/dashboard/admin/orders" class="w-full sm:w-auto">
        <Button variant="outline" class="gap-2 w-full sm:w-auto">
          <ArrowLeft class="size-4" />
          Back to Orders
        </Button>
      </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
      {/* Main Content */}
      <div class="lg:col-span-2 space-y-4 sm:space-y-6">
        {/* Order Items */}
        <Card>
          <CardHeader class="px-4 sm:px-6 pt-4 sm:pt-6">
            <CardTitle class="flex items-center gap-2 text-lg sm:text-xl">
              <Package class="size-4 sm:size-5" />
              Order Items
            </CardTitle>
            <CardDescription class="text-xs sm:text-sm">
              {orderItems.length} item{orderItems.length !== 1 ? 's' : ''} in this order
            </CardDescription>
          </CardHeader>
          <CardContent class="px-4 sm:px-6 pb-4 sm:pb-6">
            {orderItems.length > 0 ? (
              <div class="space-y-3 sm:space-y-4">
                {orderItems.map((item) => (
                  <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-4 p-3 sm:p-4 rounded-lg border border-border bg-card hover:bg-muted/50 transition-colors">
                    <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-lg overflow-hidden bg-gradient-to-br from-muted/50 to-muted/30 flex items-center justify-center shrink-0 border border-border/50">
                      {item.image ? (
                        <img
                          src={`${CDN_URL}/${item.image}`}
                          alt={item.product?.name || 'Product'}
                          class="w-full h-full object-contain p-2"
                        />
                      ) : (
                        <Package class="size-6 sm:size-8 text-muted-foreground" />
                      )}
                    </div>
                    <div class="flex-1 min-w-0 w-full sm:w-auto">
                      <h3 class="font-semibold text-base sm:text-lg mb-1 line-clamp-2">{item.product?.name || 'Unknown Product'}</h3>
                      <p class="text-xs sm:text-sm text-muted-foreground mb-2 line-clamp-2">
                        {item.product?.description || 'No description available'}
                      </p>
                      <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 text-xs sm:text-sm">
                        <span class="text-muted-foreground">
                          Quantity: <span class="font-medium text-foreground">{item.cart.quantity}</span>
                        </span>
                        <span class="text-muted-foreground">
                          Unit Price: <span class="font-medium text-foreground">${Number(item.product?.price || 0).toFixed(2)}</span>
                        </span>
                      </div>
                    </div>
                    <div class="text-left sm:text-right w-full sm:w-auto pt-2 sm:pt-0 border-t sm:border-t-0">
                      <p class="text-xs sm:text-sm text-muted-foreground mb-1">Subtotal</p>
                      <p class="text-lg sm:text-xl font-bold text-primary">
                        ${(item.cart.quantity * Number(item.product?.price || 0)).toFixed(2)}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div class="text-center py-8 sm:py-12">
                <Package class="size-12 sm:size-16 text-muted-foreground mx-auto mb-4" />
                <p class="text-sm sm:text-base text-muted-foreground">No products found for this order</p>
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      {/* Sidebar */}
      <div class="space-y-4 sm:space-y-6">
        {/* Order Summary */}
        <Card>
          <CardHeader class="px-4 sm:px-6 pt-4 sm:pt-6">
            <CardTitle class="text-lg sm:text-xl">Order Summary</CardTitle>
          </CardHeader>
          <CardContent class="px-4 sm:px-6 pb-4 sm:pb-6 space-y-3 sm:space-y-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 sm:gap-0 text-xs sm:text-sm">
              <span class="text-muted-foreground flex items-center gap-2">
                <Calendar class="size-3 sm:size-4 shrink-0" />
                Order Date
              </span>
              <span class="font-medium break-words sm:break-normal">
                {new Date(order.createdAt).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                })}
              </span>
            </div>
            <div class="border-t pt-3 sm:pt-4">
              <div class="flex items-center justify-between mb-2 text-xs sm:text-sm">
                <span class="text-muted-foreground">Subtotal</span>
                <span class="font-medium">${totalPrice.toFixed(2)}</span>
              </div>
              <div class="flex items-center justify-between mb-2 text-xs sm:text-sm">
                <span class="text-muted-foreground">Tax</span>
                <span class="font-medium">$0.00</span>
              </div>
              <div class="border-t pt-2 mt-2">
                <div class="flex items-center justify-between">
                  <span class="text-base sm:text-lg font-semibold flex items-center gap-2">
                    <DollarSign class="size-4 sm:size-5" />
                    Total
                  </span>
                  <span class="text-xl sm:text-2xl font-bold text-primary">${totalPrice.toFixed(2)}</span>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Customer Info */}
        {orderUser.length > 0 && (
          <Card>
            <CardHeader class="px-4 sm:px-6 pt-4 sm:pt-6">
              <CardTitle class="text-lg sm:text-xl">Customer Information</CardTitle>
            </CardHeader>
            <CardContent class="px-4 sm:px-6 pb-4 sm:pb-6 space-y-2">
              <div>
                <p class="text-xs sm:text-sm text-muted-foreground mb-1">Name</p>
                <p class="font-medium text-sm sm:text-base break-words">{orderUser[0].name}</p>
              </div>
              <div>
                <p class="text-xs sm:text-sm text-muted-foreground mb-1">Email</p>
                <p class="font-medium text-sm sm:text-base break-all">{orderUser[0].email}</p>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Order Info */}
        <Card>
          <CardHeader class="px-4 sm:px-6 pt-4 sm:pt-6">
            <CardTitle class="text-lg sm:text-xl">Order Information</CardTitle>
          </CardHeader>
          <CardContent class="px-4 sm:px-6 pb-4 sm:pb-6 space-y-2 sm:space-y-3">
            <div>
              <p class="text-xs sm:text-sm text-muted-foreground mb-1">Order ID</p>
              <p class="font-mono text-xs sm:text-sm font-medium">{order.id}</p>
            </div>
            <div>
              <p class="text-xs sm:text-sm text-muted-foreground mb-1">Stripe Session ID</p>
              <code class="text-[10px] sm:text-xs bg-muted px-2 py-1 rounded-md font-mono border border-border block break-all">
                {order.stripeSessionId}
              </code>
            </div>
            {downloadUrl && (
              <div class="pt-2 border-t">
                <p class="text-xs sm:text-sm text-muted-foreground mb-2">3D Model Download</p>
                <a 
                  href={downloadUrl} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 text-xs sm:text-sm text-primary hover:underline font-medium"
                >
                  <Download class="size-3 sm:size-4" />
                  Download Model File
                </a>
                <p class="text-[10px] sm:text-xs text-muted-foreground mt-1 break-all">
                  {downloadUrl}
                </p>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Actions */}
        <Card>
          <CardHeader class="px-4 sm:px-6 pt-4 sm:pt-6">
            <CardTitle class="text-lg sm:text-xl">Actions</CardTitle>
          </CardHeader>
          <CardContent class="px-4 sm:px-6 pb-4 sm:pb-6 space-y-2 sm:space-y-3">
            {order.status !== 'refunded' && order.status !== 'cancelled' && (
              <>
                <form method="POST" action={`/api/orders/${order.id}/refund`} class="w-full">
                  <Button 
                    type="submit" 
                    variant="outline" 
                    class="w-full gap-2 border-yellow-500 text-yellow-600 hover:bg-yellow-50 dark:hover:bg-yellow-950/20 text-sm sm:text-base"
                  >
                    <RefreshCw class="size-3 sm:size-4" />
                    Process Refund
                  </Button>
                </form>
                <form method="POST" action={`/api/orders/${order.id}/cancel`} class="w-full">
                  <Button 
                    type="submit" 
                    variant="destructive" 
                    class="w-full gap-2 text-sm sm:text-base"
                  >
                    <XCircle class="size-3 sm:size-4" />
                    Cancel Order
                  </Button>
                </form>
              </>
            )}
            {order.status === 'refunded' && (
              <div class="text-xs sm:text-sm text-muted-foreground text-center py-2">
                This order has been refunded
              </div>
            )}
            {order.status === 'cancelled' && (
              <div class="text-xs sm:text-sm text-muted-foreground text-center py-2">
                This order has been cancelled
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  </div>
</AdminDashboardLayout>
