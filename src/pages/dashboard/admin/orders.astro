---
import { desc, eq } from 'drizzle-orm';
import { AlertCircle, Calendar, CheckCircle2, Clock, DollarSign, Eye, Package, RefreshCw, User as UserIcon, XCircle } from 'lucide-react';
import OrdersTable from '@/components/admin/orders/OrdersTable';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { ordersTable, threeDPrintOrdersTable, user } from '@/db/schema';
import AdminDashboardLayout from '@/layouts/AdminDashboardLayout.astro';
import { getCurrentUser } from '@/lib/auth-server';
import db from '@/lib/db';

const currentUser = await getCurrentUser(Astro.request);

if (!currentUser || currentUser.role !== 'admin') {
  return Astro.redirect('/login');
}

// Récupérer les commandes normales
const normalOrders = await db
  .select({
    order: ordersTable,
    user: {
      id: user.id,
      name: user.name,
      email: user.email,
    },
  })
  .from(ordersTable)
  .leftJoin(user, eq(ordersTable.userId, user.id))
  .orderBy(desc(ordersTable.createdAt));

// Récupérer les commandes 3D
const threeDOrders = await db
  .select()
  .from(threeDPrintOrdersTable)
  .orderBy(desc(threeDPrintOrdersTable.createdAt));

// Helper function to calculate order total
const calculateOrderTotal = (cartJSON: any[]) => {
  if (!Array.isArray(cartJSON)) return 0;
  return cartJSON.reduce(
    (acc, item) => acc + Number(item.products?.price || 0) * (item.cart?.quantity || 0),
    0
  );
};

// Helper function to get status badge
const getStatusBadge = (status: string) => {
  const statusLower = status.toLowerCase();
  if (statusLower === 'completed' || statusLower === 'paid') {
    return { variant: 'default' as const, iconName: 'CheckCircle2', label: 'Completed' };
  } else if (statusLower === 'pending' || statusLower === 'processing') {
    return { variant: 'secondary' as const, iconName: 'Clock', label: 'Pending' };
  } else if (statusLower === 'cancelled') {
    return { variant: 'destructive' as const, iconName: 'XCircle', label: 'Cancelled' };
  } else if (statusLower === 'refunded') {
    return { variant: 'outline' as const, iconName: 'RefreshCw', label: 'Refunded', className: 'border-yellow-500 text-yellow-500' };
  } else {
    return { variant: 'outline' as const, iconName: 'AlertCircle', label: status };
  }
};

// Helper function to count items in order
const countOrderItems = (cartJSON: any[]) => {
  if (!Array.isArray(cartJSON)) return 0;
  return cartJSON.reduce((acc, item) => acc + (item.cart?.quantity || 0), 0);
};

// Formater les commandes normales
const formattedNormalOrders = normalOrders.map(({ order, user: orderUser }) => ({
  ...order,
  user: orderUser,
  total: calculateOrderTotal(order.cartJSON),
  itemCount: countOrderItems(order.cartJSON),
  statusInfo: getStatusBadge(order.status),
  orderType: 'normal' as const,
}));

// Formater les commandes 3D pour qu'elles soient compatibles avec le format des commandes normales
const formatted3DOrders = threeDOrders.map((order) => ({
  id: order.id,
  userId: '', // Les commandes 3D n'ont pas de userId lié à la table user
  stripeSessionId: order.stripeSessionId,
  status: order.status,
  cartJSON: [
    {
      products: {
        name: `3D Print: ${order.filename}`,
        price: Number(order.price),
      },
      cart: {
        quantity: 1,
      },
    },
  ] as any[],
  createdAt: order.createdAt,
  user: {
    id: '',
    name: order.customerName,
    email: order.customerEmail,
  },
  total: Number(order.price),
  itemCount: 1,
  statusInfo: getStatusBadge(order.status),
  orderType: '3dprint' as const,
  // Informations supplémentaires pour les commandes 3D
  _3dPrintDetails: {
    filename: order.filename,
    material: order.material,
    color: order.color,
    infill: order.infill,
    volumeCm3: order.volumeCm3,
    printer: order.printer,
    fileUrl: order.fileUrl,
  },
}));

// Combiner et trier toutes les commandes par date de création
const allOrders = [...formattedNormalOrders, ...formatted3DOrders].sort(
  (a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
);

const formattedOrders = allOrders;
---

<AdminDashboardLayout
  title="Manage Orders"
  breadcrumb={{
    '/orders': 'Manage Orders',
  }}
>
  <div class="space-y-4 sm:space-y-6 p-4 sm:p-6">
    <div class="space-y-2">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Manage Orders</h1>
      <p class="text-muted-foreground text-sm sm:text-lg">
        View and manage all customer orders, process refunds, and track order status
      </p>
    </div>

    <OrdersTable orders={JSON.parse(JSON.stringify(formattedOrders))} client:load />
  </div>
</AdminDashboardLayout>
