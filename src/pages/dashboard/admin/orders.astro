---
import { desc, eq } from 'drizzle-orm';
import { AlertCircle, Calendar, CheckCircle2, Clock, DollarSign, Eye, Package, RefreshCw, User as UserIcon, XCircle } from 'lucide-react';
import OrdersTable from '@/components/admin/orders/OrdersTable';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { ordersTable, user } from '@/db/schema';
import AdminDashboardLayout from '@/layouts/AdminDashboardLayout.astro';
import { getCurrentUser } from '@/lib/auth-server';
import db from '@/lib/db';

const currentUser = await getCurrentUser(Astro.request);

if (!currentUser || currentUser.role !== 'admin') {
  return Astro.redirect('/login');
}

const orders = await db
  .select({
    order: ordersTable,
    user: {
      id: user.id,
      name: user.name,
      email: user.email,
    },
  })
  .from(ordersTable)
  .leftJoin(user, eq(ordersTable.userId, user.id))
  .orderBy(desc(ordersTable.createdAt));

// Helper function to calculate order total
const calculateOrderTotal = (cartJSON: any[]) => {
  if (!Array.isArray(cartJSON)) return 0;
  return cartJSON.reduce(
    (acc, item) => acc + Number(item.products?.price || 0) * (item.cart?.quantity || 0),
    0
  );
};

// Helper function to get status badge
const getStatusBadge = (status: string) => {
  const statusLower = status.toLowerCase();
  if (statusLower === 'completed' || statusLower === 'paid') {
    return { variant: 'default' as const, iconName: 'CheckCircle2', label: 'Completed' };
  } else if (statusLower === 'pending' || statusLower === 'processing') {
    return { variant: 'secondary' as const, iconName: 'Clock', label: 'Pending' };
  } else if (statusLower === 'cancelled') {
    return { variant: 'destructive' as const, iconName: 'XCircle', label: 'Cancelled' };
  } else if (statusLower === 'refunded') {
    return { variant: 'outline' as const, iconName: 'RefreshCw', label: 'Refunded', className: 'border-yellow-500 text-yellow-500' };
  } else {
    return { variant: 'outline' as const, iconName: 'AlertCircle', label: status };
  }
};

// Helper function to count items in order
const countOrderItems = (cartJSON: any[]) => {
  if (!Array.isArray(cartJSON)) return 0;
  return cartJSON.reduce((acc, item) => acc + (item.cart?.quantity || 0), 0);
};

// Format orders with user info and calculated totals
const formattedOrders = orders.map(({ order, user: orderUser }) => ({
  ...order,
  user: orderUser,
  total: calculateOrderTotal(order.cartJSON),
  itemCount: countOrderItems(order.cartJSON),
  statusInfo: getStatusBadge(order.status),
}));
---

<AdminDashboardLayout
  title="Manage Orders"
  breadcrumb={{
    '/orders': 'Manage Orders',
  }}
>
  <div class="space-y-6 p-6">
    <div class="space-y-2">
      <h1 class="text-3xl font-bold tracking-tight">Manage Orders</h1>
      <p class="text-muted-foreground text-lg">
        View and manage all customer orders, process refunds, and track order status
      </p>
    </div>

    <OrdersTable orders={JSON.parse(JSON.stringify(formattedOrders))} client:load />
  </div>
</AdminDashboardLayout>
