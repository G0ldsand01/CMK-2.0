---
import { actions } from 'astro:actions';
import UsersTable from '@/components/admin/users/UsersTable';
import AdminDashboardLayout from '@/layouts/AdminDashboardLayout.astro';
import { getCurrentUser } from '@/lib/auth-server';

const user = await getCurrentUser(Astro.request);

if (!user || user.role !== 'admin') {
  return Astro.redirect('/dashboard');
}

const { data, error } = await Astro.callAction(
  actions.admin.users.getUsers,
  {
    limit: 20,
    offset: 0,
  }
);

if (error) {
  console.error(error);
}

const users = data?.data || [];
const totalUsers = data?.total || 0;
---
<AdminDashboardLayout title="Users" breadcrumb={{ '/users': 'Manage Users' }}>
  <div class="space-y-4 sm:space-y-6 p-4 sm:p-6">
    <!-- Welcome Section -->
    <div class="space-y-2">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Manage Users</h1>
      <p class="text-muted-foreground text-sm sm:text-base">
        View and manage all user accounts, roles, and permissions
      </p>
    </div>

    <!-- Users Table -->
    <UsersTable
      client:load
      initialUsers={users}
      totalUsers={totalUsers}
    />
  </div>
</AdminDashboardLayout>
