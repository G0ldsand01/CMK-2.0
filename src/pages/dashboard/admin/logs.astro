---
import { actions } from 'astro:actions';
import SecurityLogsViewer from '@/components/admin/logs/SecurityLogsViewer';
import AdminDashboardLayout from '@/layouts/AdminDashboardLayout.astro';
import { getCurrentUser } from '@/lib/auth-server';

const user = await getCurrentUser(Astro.request);

if (!user || user.role !== 'admin') {
  return Astro.redirect('/dashboard');
}

const { data: logsData, error } = await Astro.callAction(
  actions.admin.logs.getLogs,
  { limit: 50, offset: 0 }
);

if (error) {
  console.error('Error fetching logs:', error);
}

// Serialize dates to strings for React props
const logs = (logsData?.data || []).map((log) => {
	const timestamp = log.timestamp instanceof Date 
		? log.timestamp.toISOString() 
		: typeof log.timestamp === 'string' 
			? log.timestamp 
			: new Date(log.timestamp).toISOString();
	return {
		...log,
		timestamp,
	};
});
const totalLogs = logsData?.total || 0;
---
<AdminDashboardLayout
	title="Security Logs"
	breadcrumb={{
  '/logs': 'Security Logs',
}}
>
	<div class="space-y-4 sm:space-y-6 p-4 sm:p-6">
		<div class="space-y-2">
			<h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Security Logs</h1>
			<p class="text-muted-foreground text-sm sm:text-base">
				View security events and audit logs
			</p>
		</div>

		<SecurityLogsViewer
			client:load
			initialLogs={logs}
			totalLogs={totalLogs}
		/>
	</div>
</AdminDashboardLayout>

