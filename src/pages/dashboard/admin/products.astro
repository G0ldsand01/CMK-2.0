---
import { actions } from 'astro:actions';
import AddProductForm from '@/components/admin/products/AddProductForm';
import ProductsTable from '@/components/admin/products/ProductsTable';
import AdminDashboardLayout from '@/layouts/AdminDashboardLayout.astro';
import { getUser } from '@/lib/user';

const user = await getUser(Astro.request);

if (!user || !user.isAdmin()) {
  return Astro.redirect('/dashboard');
}

const productsResult = await Astro.callAction(
  actions.admin.products.getProducts,
  {
    limit: 10,
    offset: 0,
  }
);

// Extract the data array and total from the productsResult
const products = productsResult?.data || [];
const totalProducts = productsResult?.total || 0;

const categories = ['mouse', 'keyboard', 'headset', 'model', 'tech', 'iot'];
const types = ['products', 'models', 'tech', 'iot'];
---

<AdminDashboardLayout
  title="Manage Products"
  breadcrumb={{
    '/products': 'Manage Products',
  }}
>
  <div class="space-y-6 p-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold">Products</h1>
        <p class="text-muted-foreground">Manage your store products</p>
      </div>
      <AddProductForm client:load categories={categories} types={types} />
    </div>

    <ProductsTable
      client:load
      initialProducts={products}
      totalProducts={totalProducts}
      categories={categories}
      types={types}
    />
  </div>
</AdminDashboardLayout>
