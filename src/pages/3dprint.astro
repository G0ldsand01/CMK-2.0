---
import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils'; // Import cn for class name merging
import Layout from '../layouts/Layout.astro';
---

<Layout title="3D Print Quote Service" navbar={true}>
  <div class="container mx-auto p-4 md:p-8 lg:p-12">
    <div class="title text-center mb-6 md:mb-8 lg:mb-10">
      <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-800 dark:text-gray-200">
        3D Print Quote Service
      </h1>
      <p class="text-gray-600 dark:text-gray-400 text-sm md:text-base lg:text-lg">
        Send us your files and we will print them for you
      </p>
    </div>
    <div class="form">
      <form class="space-y-4 md:space-y-6 lg:space-y-8">
        <div class="page1 flex flex-col items-center">
          <input
            type="text"
            placeholder="Name"
            class="input-field"
          />
          <input
            type="email"
            placeholder="Email"
            class="input-field"
            
          />
          <input
            type="text"
            placeholder="Phone"
            class="input-field"
           
          />
          <input
            type="text"
            placeholder="Address"
            class="input-field"
          
          />
          <input
            type="text"
            placeholder="City"
            class="input-field"
            
          />
          <input
            type="text"
            placeholder="State"
            class="input-field"
           
          />
          <input
            type="text"
            placeholder="Zip"
            class="input-field"
            
          />
          <Button
            id="next-page-button"
            type="button"
            class="button"
          >
            Next
          </Button>
        </div>

        <div class="page2 flex flex-col items-center" style="display: none;">
          <input
            type="file"
            name="file"
            id="file"
            accept=".stl"
            class="input-field"
          />
          <select
            id="material-select"
            class="select-field"
          >
            <option value="PLA">PLA</option>
            <option value="ABS">ABS</option>
            <option value="PETG">PETG</option>
            <option value="TPU">TPU</option>
          </select>
          <label for="size-printer" class="label-field">Size / Printer:</label>
          <select
            name="size-printer"
            id="size-printer"
            class="select-field"
          >
            <option value="small">Small / A1 mini / 180mm</option>
            <option value="ender3">Ender 3 / 220mm</option>
            <option value="large">Large / A1 / 256mm</option>
          </select>
          <label for="color" class="label-field">Color:</label>
          <select
            id="color-select"
            class="select-field"
          >
            <option value="#000000">Black</option>
            <option value="#ffffff">White</option>
            <option value="#808080">Grey</option>
            <option value="#0000ff">Blue</option>
          </select>
          <input
            type="text"
            placeholder="Anything we should know?"
            class="input-field"
          />
          <div class="flex justify-between w-full max-w-md">
            <Button
              id="prev-page-button"
              type="button"
              class="button prev-button"
            >
              Previous
            </Button>
            <Button
              id="next-page-button"
              type="button"
              class="button next-button"
            >
              Next
            </Button>
          </div>
        </div>

        <div class="page3 flex flex-col items-center" style="display: none;">
          <div class="title text-center mb-4">
            <h1 class="text-xl md:text-2xl lg:text-3xl font-bold text-gray-800 dark:text-gray-200">
              Here's a preview of your model
            </h1>
          </div>
          <div class="3d-viewer w-full max-w-md">
            <canvas
              id="3d-canvas"
              width="300"
              height="300"
              class="border border-gray-300 dark:border-gray-700 rounded-md"
            ></canvas>
          </div>
          <div class="mt-4 text-center">
            <p class="text-base md:text-lg lg:text-xl text-gray-700 dark:text-gray-300">
              Estimated Cost: <span
                id="cost-estimate"
                class="font-semibold text-green-600 dark:text-green-400"
                >0.00 $</span
              >
            </p>
          </div>
          <div class="flex justify-between w-full max-w-md mt-4">
            <Button
              id="prev-page-button"
              type="button"
              class="button prev-button"
            >
              Previous
            </Button>
            <Button
              id="checkout-print-button"
              type="submit"
              class="button checkout-button"
            >
              <i class="fa fa-shopping-cart mr-2"></i>
              Go to Checkout & Pay
            </Button>
          </div>
        </div>
      </form>
    </div>
  </div>
</Layout>

<style>
  .container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 1rem;
  }

  .title {
    text-align: center;
    color: var(--color-foreground);
    background-color: var(--color-muted);
    border-radius: 1rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    width: 90%; /* Adjust width for smaller screens */
  }

  .form {
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: var(--color-muted);
    padding: 1.5rem;
    border-radius: 1rem;
    width: 90%; /* Adjust width for smaller screens */
  }

  .input-field,
  .select-field {
    margin: 0.75rem 0;
    padding: 0.75rem;
    width: 100%;
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    box-shadow: var(--shadow-sm);
    font-size: 0.9rem;
    color: var(--color-text);
    background-color: var(--color-bg);
  }

  .label-field {
    font-size: 0.9rem;
    color: var(--color-text);
    margin-top: 0.5rem;
    align-self: flex-start;
  }

  .button {
    margin-top: 1rem;
    padding: 0.75rem 1.5rem;
    font-weight: bold;
    border-radius: 0.5rem;
    box-shadow: var(--shadow-md);
    cursor: pointer;
    text-align: center;
    font-size: 0.9rem;
  }

  .prev-button {
    background-color: var(--color-gray-300);
    color: var(--color-gray-800);
    transition: background-color 0.2s ease-in-out;
  }

  .prev-button:hover {
    background-color: var(--color-gray-400);
  }

  .next-button {
    background-color: var(--color-blue-500);
    color: white;
    transition: background-color 0.2s ease-in-out;
  }

  .next-button:hover {
    background-color: var(--color-blue-700);
  }

  .checkout-button {
    background-color: var(--color-green-500);
    color: white;
    transition: background-color 0.2s ease-in-out;
  }

  .checkout-button:hover {
    background-color: var(--color-green-700);
  }
  option {
    background-color: var(--color-muted);
    color: var(--color-foreground);
  }
  .3d-viewer {
    width: 100%;
    max-width: 300px;
    height: auto;
    aspect-ratio: 1 / 1;
    border: 1px solid var(--color-border);
    margin: 0.75rem 0;
    position: relative;
    border-radius: 0.5rem;
    background-color: var(--color-bg-secondary);
  }

  #3d-canvas {
    width: 100%;
    height: 100%;
    display: block;
    border-radius: 0.5rem;
  }

  @media (min-width: 768px) {
    .container {
      padding: 2rem;
    }

    .title {
      font-size: 1.5rem;
      margin-bottom: 2rem;
      border-radius: 1rem;
      padding: 2rem;
      width: 70%;
    }

    .form {
      padding: 2rem;
      border-radius: 1rem;
      width: 70%;
    }

    .input-field,
    .select-field,
    .label-field,
    .button {
      font-size: 1rem;
      padding: 0.8rem;
      margin: 0.8rem 0;
    }

    .button {
      padding: 0.8rem 1.6rem;
    }

    .3d-viewer {
      max-width: 400px;
      margin: 1rem 0;
    }
  }

  @media (min-width: 1024px) {
    .container {
      padding: 3rem;
    }

    .title {
      font-size: 2rem;
      margin-bottom: 3rem;
      border-radius: 1.25rem;
      padding: 2.5rem;
      width: 50%;
    }

    .form {
      padding: 2.5rem;
      border-radius: 1.25rem;
      width: 50%;
    }

    .input-field,
    .select-field,
    .label-field,
    .button {
      font-size: 1.1rem;
      padding: 0.9rem;
      margin: 0.9rem 0;
    }

    .button {
      padding: 0.9rem 1.8rem;
    }

    .3d-viewer {
      max-width: 500px;
      margin: 1.25rem 0;
    }
  }
</style>

<script>
  import * as THREE from "three";
  import { STLLoader } from "three/examples/jsm/loaders/STLLoader.js";
  import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";

  // import page elements
  const page1 = document.querySelector(".page1");
  const page2 = document.querySelector(".page2");
  const page3 = document.querySelector(".page3");

  let currentPage = 1;
  const totalPages = 3;
  const form = document.querySelector("form");

  const fileInput = document.getElementById("file") as HTMLInputElement;
  const materialSelect = document.getElementById(
    "material-select"
  ) as HTMLSelectElement;
  let model: THREE.Mesh | null = null;
  let scene: THREE.Scene | undefined;
  let camera: THREE.PerspectiveCamera | undefined;
  let renderer: THREE.WebGLRenderer | undefined;
  let controls: OrbitControls | undefined;
  let loader: STLLoader;
  let modelVolume = 0;
  let currentScale = 1;

  const materialCosts = {
    PLA: 0.025,
    ABS: 0.03,
    PETG: 0.04,
    TPU: 0.06,
  };

  const materialDensities = {
    // in g/mm^3 (approximate)
    PLA: 1.24e-6,
    ABS: 1.05e-6,
    PETG: 1.27e-6,
    TPU: 1.12e-6,
  };

  // Initialize the viewer
  function initViewer() {
    const canvas = document.getElementById("3d-canvas") as HTMLCanvasElement;
    if (!canvas) return;

    renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);

    camera = new THREE.PerspectiveCamera(
      45,
      canvas.clientWidth / canvas.clientHeight,
      0.1,
      1000
    );
    camera.position.set(0, 0, 100);
    scene.add(camera);

    const ambient = new THREE.AmbientLight(0x888888);
    scene.add(ambient);
    const directional = new THREE.DirectionalLight(0xffffff, 0.8);
    directional.position.set(1, 1, 1).normalize();
    scene.add(directional);

    loader = new STLLoader();

    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.1;
    controls.rotateSpeed = 0.5;

    // Add resize listener to adjust camera and renderer on window resize
    window.addEventListener("resize", () => {
      if (camera && renderer) {
        camera.aspect = canvas.clientWidth / canvas.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      }
    });

    animate();
  }

  function animate() {
    requestAnimationFrame(animate);
    if (model) model.rotation.z += 0.01;
    controls?.update();
    renderer?.render(scene, camera);
  }

  function loadSTL(file: File) {
    const reader = new FileReader();
    reader.onload = function (event) {
      const contents = event.target?.result;
      if (!contents) {
        console.error("Failed to load file");
        return;
      }

      try {
        const geometry = loader.parse(contents as string | ArrayBuffer);

        if (model) {
          scene?.remove(model);
        }
        const material = new THREE.MeshStandardMaterial({
          color: 0x009578,
          wireframe: false,
        });
        model = new THREE.Mesh(geometry, material);
        geometry.computeBoundingBox();
        if (geometry.boundingBox) {
          const center = geometry.boundingBox.getCenter(new THREE.Vector3());
          model.position.sub(center);
        }

        scene?.add(model);

        geometry.computeVolume();
        modelVolume = geometry.volume;

        updateCostEstimate();
      } catch (error) {
        console.error("Error parsing STL file:", error);
        alert("Error: Invalid STL file. Please upload a valid .stl file.");
      }
    };
    reader.onerror = function (error) {
      console.error("FileReader Error:", error);
      alert("Error reading file. Please try again.");
    };
    reader.readAsArrayBuffer(file);
  }

  // Event listener for file input change
  fileInput.addEventListener("change", (event) => {
    const target = event.target as HTMLInputElement;
    if (target.files && target.files.length > 0) {
      loadSTL(target.files[0]);
    }
  });

  // Submit the form
  form?.addEventListener("submit", (event) => {
    event.preventDefault();
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.cost = calculateCost();
    console.log(data);
    alert("Your print request has been submitted! (This is a demo)");
  });

  // Update the cost estimate
  function updateCostEstimate() {
    const cost = calculateCost();
    const costElement = document.getElementById("cost-estimate");
    if (costElement) {
      costElement.textContent = cost.toFixed(2) + " $";
    }
  }
  // Calculate the cost of the model
  function calculateCost() {
    const materialType = (
      document.getElementById("material-select") as HTMLSelectElement
    ).value;
    const density = materialDensities[materialType] || materialDensities.PLA;
    const costPerGram = materialCosts[materialType] || materialCosts.PLA;
    const weight = modelVolume * density * 1000; // convert mm^3 to cm^3, density is g/cm^3
    const cost = weight * costPerGram;
    return cost;
  }
  // Switch to the next page
  const nextPageButtons = document.querySelectorAll("#next-page-button");
  nextPageButtons.forEach((button) => {
    button.addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        updatePageVisibility();
      }
    });
  });

  // Switch to the previous page
  const prevPageButtons = document.querySelectorAll("#prev-page-button");
  prevPageButtons.forEach((button) => {
    button.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        updatePageVisibility();
      }
    });
  });

  function updatePageVisibility() {
    // Hide all pages
    if (page1) page1.style.display = "none";
    if (page2) page2.style.display = "none";
    if (page3) page3.style.display = "none";

    // Show current page
    switch (currentPage) {
      case 1:
        if (page1) page1.style.display = "flex";
        break;
      case 2:
        if (page2) page2.style.display = "flex";
        break;
      case 3:
        if (page3) page3.style.display = "flex";
        break;
    }

    // Update button states
    prevPageButtons.forEach((button) => {
      button.disabled = currentPage === 1;
    });

    nextPageButtons.forEach((button) => {
      button.disabled = currentPage === totalPages;
    });
  }

  // Initialize page visibility and 3D viewer
  updatePageVisibility();
  document.addEventListener("DOMContentLoaded", () => {
    initViewer();
  });
</script>
