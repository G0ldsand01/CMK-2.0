---
import Layout from "../layouts/Layout.astro";
---
<Layout title="3D Print Quote Service" navbar={true}>
  <main class="page">
    <div id="quote-root" class="card">
      <header class="card-header">
        <h1>3D Print Quote Service</h1>
        <p>Upload your model, select filament, and get an instant estimate.</p>
        <div class="progress-strip" id="progress-strip"></div>
        <p id="error-box" class="error hidden"></p>
      </header>

      <form id="quote-form" class="form">
        <div class="step-indicator">
          <span id="step-label">Step 1 of 3 — Customer Info</span>
        </div>

        <!-- ================= STEP 1 ================= -->
        <section class="step step-1 active">
          <div class="form-inner">
            <div class="row two">
              <div class="field">
                <label for="firstName">First name *</label>
                <input id="firstName" class="input" required />
              </div>
              <div class="field">
                <label for="lastName">Last name *</label>
                <input id="lastName" class="input" required />
              </div>
            </div>

            <div class="row full">
              <div class="field">
                <label for="email">Email *</label>
                <input id="email" type="email" class="input" required />
              </div>
            </div>

            <div class="row full">
              <div class="field">
                <label for="address">Address *</label>
                <input
                  id="address"
                  class="input"
                  required
                  placeholder="Street number, road"
                />
              </div>
            </div>

            <div class="row two">
              <div class="field">
                <label for="city">City *</label>
                <input id="city" class="input" required />
              </div>
              <div class="field">
                <label for="zip">Postal / ZIP *</label>
                <input id="zip" class="input" required />
              </div>
            </div>

            <div class="row two">
              <div class="field">
                <label for="state">Province / State *</label>
                <input id="state" class="input" required />
              </div>
              <div class="field">
                <label for="country">Country *</label>
                <input id="country" value="Canada" class="input" required />
              </div>
            </div>
          </div>
        </section>

        <!-- ================= STEP 2 ================= -->
        <section class="step step-2 hidden">
          <div class="form-inner wide">
            <div class="row full">
              <div class="field">
                <label for="modelFile">Upload 3D Model *</label>
                <input
                  id="modelFile"
                  type="file"
                  accept=".stl,.3mf,.obj,.glb,.gltf,.fbx"
                  class="fileinput"
                  required
                />
                <p class="note">Supports .stl, .3mf, .obj, .glb, .gltf, .fbx</p>
              </div>
            </div>

            <!-- Filament horizontal -->
            <div class="row full">
              <label>Filament *</label>
              <div id="filament-carousel" class="filament-carousel">
                <button
                  type="button"
                  class="filament-chip active"
                  data-name="PLA Basic White"
                  data-color="#f5f5f5"
                >
                  <span class="chip-color" style="background:#f5f5f5"
                  ></span><span class="chip-name">PLA Basic White</span>
                </button>
                <button
                  type="button"
                  class="filament-chip"
                  data-name="PLA Basic Black"
                  data-color="#1a1a1a"
                >
                  <span class="chip-color" style="background:#1a1a1a"
                  ></span><span class="chip-name">PLA Basic Black</span>
                </button>
                <button
                  type="button"
                  class="filament-chip"
                  data-name="PLA Basic Gray"
                  data-color="#7d7d7d"
                >
                  <span class="chip-color" style="background:#7d7d7d"
                  ></span><span class="chip-name">PLA Basic Gray</span>
                </button>
                <button
                  type="button"
                  class="filament-chip"
                  data-name="PLA Basic Blue"
                  data-color="#004fce"
                >
                  <span class="chip-color" style="background:#004fce"
                  ></span><span class="chip-name">PLA Basic Blue</span>
                </button>
                <button
                  type="button"
                  class="filament-chip"
                  data-name="PLA Basic Red"
                  data-color="#bb2b2b"
                >
                  <span class="chip-color" style="background:#bb2b2b"
                  ></span><span class="chip-name">PLA Basic Red</span>
                </button>
                <button
                  type="button"
                  class="filament-chip"
                  data-name="PLA Basic Green"
                  data-color="#108b1b"
                >
                  <span class="chip-color" style="background:#108b1b"
                  ></span><span class="chip-name">PLA Basic Green</span>
                </button>
                <button
                  type="button"
                  class="filament-chip"
                  data-name="PETG Transparent"
                  data-color="#d0d6dc"
                >
                  <span class="chip-color" style="background:#d0d6dc"
                  ></span><span class="chip-name">PETG Transparent</span>
                </button>
                <button
                  type="button"
                  class="filament-chip"
                  data-name="ABS Black"
                  data-color="#111"
                >
                  <span class="chip-color" style="background:#111"></span><span
                    class="chip-name">ABS Black</span
                  >
                </button>
                <button
                  type="button"
                  class="filament-chip"
                  data-name="TPU Transparent"
                  data-color="#e0e0e0"
                >
                  <span class="chip-color" style="background:#e0e0e0"
                  ></span><span class="chip-name">TPU Transparent</span>
                </button>
              </div>
            </div>

            <div class="row two">
              <div class="field">
                <label for="infill">Infill (%)</label>
                <div class="infill-row">
                  <input
                    id="infill"
                    type="range"
                    min="0"
                    max="100"
                    value="15"
                  />
                  <span id="infill-value">15%</span>
                </div>
                <p class="note">
                  15–25 % is good for most cosmetic / functional parts.
                </p>
              </div>
            </div>

            <div class="row full">
              <div class="field">
                <label for="notes">Notes / special instructions</label>
                <textarea
                  id="notes"
                  rows="3"
                  class="input"
                  placeholder="Ex : color brand, supports, orientation..."
                ></textarea>
              </div>
            </div>
          </div>
        </section>

        <!-- ================= STEP 3 ================= -->
        <section class="step step-3 hidden">
          <h2 class="viewer-title">Model Preview</h2>
          <p class="price-line">
            Estimated cost: <span id="cost" class="price">0.00 $</span>
          </p>
          <div id="cost-breakdown" class="breakdown" style="margin: 1rem;">
          </div>
          <div class="viewer">
            <div class="loading" id="loading"></div>
            <canvas id="stl-canvas"></canvas>
          </div>

          <p id="size-line" class="size-line" style="margin: 1rem;">
            Detected size: —
          </p>
          <!-- <p id="viewer-status" class="status">Load a model to preview.</p> -->
        </section>

        <!-- ACTIONS -->
        <div class="actions">
          <button id="prev-btn" type="button" class="btn" disabled>
            Previous
          </button>
          <button id="next-btn" type="button" class="btn primary">Next</button>
          <button id="checkout-btn" type="button" class="btn success hidden">
            Checkout
          </button>
        </div>
      </form>
    </div>
  </main>

  <!-- ================= SCRIPT ================= -->
  <script type="module">
    import * as THREE from "https://esm.sh/three@0.160.0";
    import { STLLoader } from "https://esm.sh/three@0.160.0/examples/jsm/loaders/STLLoader.js";
    import { OrbitControls } from "https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js";

    const steps = [...document.querySelectorAll(".step")];
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const checkoutBtn = document.getElementById("checkout-btn");
    const strip = document.getElementById("progress-strip");
    const stepLabel = document.getElementById("step-label");
    const fileInput = document.getElementById("modelFile");
    const errorBox = document.getElementById("error-box");
    const canvas = document.getElementById("stl-canvas");
    const loading = document.getElementById("loading");
    const viewerStatus = document.getElementById("viewer-status");
    const sizeLine = document.getElementById("size-line");
    const costEl = document.getElementById("cost");
    const breakdown = document.getElementById("cost-breakdown");
    const filamentCarousel = document.getElementById("filament-carousel");
    const infillSlider = document.getElementById("infill");
    const infillValue = document.getElementById("infill-value");

    // form fields
    const firstName = document.getElementById("firstName");
    const lastName = document.getElementById("lastName");
    const email = document.getElementById("email");
    const address = document.getElementById("address");
    const city = document.getElementById("city");
    const state = document.getElementById("state");
    const zip = document.getElementById("zip");
    const country = document.getElementById("country");
    const notes = document.getElementById("notes");

    let step = 0;
    let file = null;
    let scene, camera, renderer, controls, mesh;
    let lastVolume = 0;
    let lastDims = { x: 0, y: 0, z: 0 };
    let lastPrinter = "Unknown size";
    let selectedMaterial = { name: "PLA Basic White", color: "#f5f5f5" };

    /* === STEP NAVIGATION === */
    function setProgress(i) {
      const pct = ((i + 1) / steps.length) * 100;
      strip.style.setProperty("--progress", pct + "%");
    }

    function showStep(i) {
      steps.forEach((s, idx) => {
        s.classList.toggle("active", idx === i);
        s.classList.toggle("hidden", idx !== i);
      });
      step = i;
      stepLabel.textContent =
        i === 0
          ? "Step 1 of 3 — Customer Info"
          : i === 1
            ? "Step 2 of 3 — Print Details"
            : "Step 3 of 3 — Preview & Checkout";
      prevBtn.disabled = i === 0;
      nextBtn.classList.toggle("hidden", i === steps.length - 1);
      checkoutBtn.classList.toggle("hidden", i !== steps.length - 1);
      setProgress(i);
      if (i === 2 && file) loadModel(file);
    }

    function validate(i) {
      errorBox.classList.add("hidden");
      if (i === 0) {
        const ids = [
          "firstName",
          "lastName",
          "email",
          "address",
          "city",
          "state",
          "zip",
          "country",
        ];
        for (const id of ids) {
          const el = document.getElementById(id);
          if (!el.value.trim()) {
            errorBox.textContent = "Please fill all required fields.";
            errorBox.classList.remove("hidden");
            return false;
          }
        }
      }
      if (i === 1 && !fileInput.files.length) {
        errorBox.textContent = "Please upload a model.";
        errorBox.classList.remove("hidden");
        return false;
      }
      return true;
    }

    prevBtn.onclick = () => {
      if (step > 0) showStep(step - 1);
    };
    nextBtn.onclick = () => {
      if (validate(step) && step < steps.length - 1) showStep(step + 1);
    };

    /* === FILAMENT CAROUSEL (AUTO-CENTER + DRAG + TOUCH) === */
    let isDragging = false,
      startX,
      scrollLeft;

    // mouse drag
    filamentCarousel.addEventListener("mousedown", (e) => {
      isDragging = true;
      startX = e.pageX - filamentCarousel.offsetLeft;
      scrollLeft = filamentCarousel.scrollLeft;
    });
    filamentCarousel.addEventListener("mouseleave", () => (isDragging = false));
    filamentCarousel.addEventListener("mouseup", () => (isDragging = false));
    filamentCarousel.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      e.preventDefault();
      const x = e.pageX - filamentCarousel.offsetLeft;
      const walk = (x - startX) * 1.2;
      filamentCarousel.scrollLeft = scrollLeft - walk;
    });

    // touch drag
    filamentCarousel.addEventListener("touchstart", (e) => {
      startX = e.touches[0].pageX;
      scrollLeft = filamentCarousel.scrollLeft;
    });
    filamentCarousel.addEventListener(
      "touchmove",
      (e) => {
        const x = e.touches[0].pageX;
        const walk = (x - startX) * 1.2;
        filamentCarousel.scrollLeft = scrollLeft - walk;
      },
      { passive: true }
    );

    // auto-center selected chip
    function centerChip(chip) {
      const chipRect = chip.getBoundingClientRect();
      const containerRect = filamentCarousel.getBoundingClientRect();
      const offset =
        chipRect.left -
        containerRect.left -
        (containerRect.width / 2 - chipRect.width / 2);
      filamentCarousel.scrollBy({ left: offset, behavior: "smooth" });
    }

    // click handler
    filamentCarousel.querySelectorAll(".filament-chip").forEach((chip) => {
      chip.addEventListener("click", () => {
        filamentCarousel
          .querySelectorAll(".filament-chip")
          .forEach((c) => c.classList.remove("active"));
        chip.classList.add("active");
        selectedMaterial = {
          name: chip.dataset.name,
          color: chip.dataset.color,
        };
        centerChip(chip);
        if (mesh) mesh.material.color.set(selectedMaterial.color);
        if (lastVolume) updateEstimate();
      });
    });

    /* === INFILL SLIDER === */
    infillSlider.addEventListener("input", () => {
      infillValue.textContent = infillSlider.value + "%";
      if (lastVolume) updateEstimate();
    });

    /* === FILE HANDLER === */
    fileInput.onchange = (e) => {
      file = e.target.files[0];
      if (step === 2 && file) loadModel(file);
    };

    /* === COST ESTIMATION === */
    function updateEstimate() {
      const est = estimateCost(
        lastVolume,
        selectedMaterial.name,
        Number(infillSlider.value)
      );

      // Add handling time (0.5h setup + real-life 24h post-print delay)
      const handlingTimeHours = 0.5;
      const postProcessingDelayHours = 24;
      const totalPrintTime = est.timeHours + handlingTimeHours;

      // Human-readable print time
      const hrs = Math.floor(totalPrintTime);
      const mins = Math.round((totalPrintTime - hrs) * 60);
      const timeText = hrs > 0 ? `${hrs}h ${mins}min` : `${mins}min`;

      // Human-readable total completion estimate
      const completionDate = new Date();
      completionDate.setHours(
        completionDate.getHours() + postProcessingDelayHours
      );
      const options = { weekday: "short", hour: "2-digit", minute: "2-digit" };
      const formattedCompletion = completionDate.toLocaleString([], options);

      // Display only what’s relevant to the user
      costEl.textContent = est.total.toFixed(2) + " $";
      breakdown.textContent = `Estimated print time: ${timeText} ⏱️ 
  • Ready for shipping or pickup after ${formattedCompletion} (Time may vary depending on your location and demand).`;
    }

    /* === THREE.JS MODEL LOADING === */
    function initThree() {
      if (renderer) return;
      renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setClearColor(0xd9dadb, 1);
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(
        60,
        canvas.clientWidth / canvas.clientHeight,
        0.1,
        1000
      );
      camera.position.set(0, 0, 120);
      const ambient = new THREE.AmbientLight(0xffffff, 0.9);
      const dir = new THREE.DirectionalLight(0xffffff, 1);
      dir.position.set(3, 2, 5);
      scene.add(ambient, dir);
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      const loop = () => {
        requestAnimationFrame(loop);
        controls.update();
        renderer.render(scene, camera);
      };
      loop();
    }

    async function loadModel(file) {
      initThree();
      //viewerStatus.textContent = "Loading model...";
      loading.style.display = "grid";
      if (mesh) {
        scene.remove(mesh);
        mesh.geometry.dispose();
      }
      const loader = new STLLoader();
      const buf = await file.arrayBuffer();
      const geometry = loader.parse(buf);
      geometry.computeBoundingBox();
      const material = new THREE.MeshStandardMaterial({
        color: selectedMaterial.color || "#cccccc",
        roughness: 0.6,
        metalness: 0.1,
      });
      mesh = new THREE.Mesh(geometry, material);
      const box = geometry.boundingBox;
      const size = new THREE.Vector3();
      box.getSize(size);
      const center = new THREE.Vector3();
      box.getCenter(center);
      mesh.position.sub(center);
      scene.add(mesh);
      const maxDim = Math.max(size.x, size.y, size.z);
      camera.position.set(maxDim * 1.3, maxDim * 1.1, maxDim * 1.5);
      controls.target.set(0, 0, 0);
      controls.update();

      lastDims = {
        x: Number(size.x.toFixed(1)),
        y: Number(size.y.toFixed(1)),
        z: Number(size.z.toFixed(1)),
      };
      if (size.x <= 180 && size.y <= 180 && size.z <= 180)
        lastPrinter = "A1 Mini (180×180×180)";
      else if (size.x <= 220 && size.y <= 220 && size.z <= 220)
        lastPrinter = "Ender 3 (220×220×220)";
      else if (size.x <= 256 && size.y <= 256 && size.z <= 256)
        lastPrinter = "Bambu A1 (256×256×256)";
      else lastPrinter = "Too large / custom";

      sizeLine.textContent = `Detected size: ${lastDims.x} × ${lastDims.y} × ${lastDims.z} mm — Printer: ${lastPrinter}`;
      const vol = calcVolume(geometry);
      lastVolume = vol;
      updateEstimate();
      //viewerStatus.textContent = "Model loaded.";
      loading.style.display = "none";
    }

    function calcVolume(geometry) {
      const pos = geometry.attributes.position.array;
      let volume = 0;
      for (let i = 0; i < pos.length; i += 9) {
        const ax = pos[i],
          ay = pos[i + 1],
          az = pos[i + 2];
        const bx = pos[i + 3],
          by = pos[i + 4],
          bz = pos[i + 5];
        const cx = pos[i + 6],
          cy = pos[i + 7],
          cz = pos[i + 8];
        volume +=
          (ax * (by * cz - bz * cy) -
            ay * (bx * cz - bz * cx) +
            az * (bx * cy - by * cx)) /
          6;
      }
      return Math.abs(volume) / 1000;
    }

    function estimateCost(vol, mat, infill) {
      let p = { density: 1.24, pricePerKg: 25 };
      if (mat.includes("PETG")) p = { density: 1.27, pricePerKg: 30 };
      if (mat.includes("ABS")) p = { density: 1.04, pricePerKg: 28 };
      if (mat.includes("TPU")) p = { density: 1.2, pricePerKg: 35 };
      const infillFactor = 0.6 + (infill || 15) / 200;
      const speed = 25;
      const grams = vol * p.density * infillFactor;
      const materialCost = (grams / 1000) * p.pricePerKg;
      const timeHours = (vol / speed) * infillFactor;
      const timeCost = timeHours * 3.5;
      const energyCost = (0.12 * 120 * timeHours) / 1000;
      const total = (materialCost + timeCost + energyCost) * 1.15;
      return { materialCost, timeHours, energyCost, total };
    }

    /* === CHECKOUT === */
    checkoutBtn.onclick = async () => {
      if (!validate(0) || !validate(1) || !file) {
        showStep(0);
        return;
      }
      const humanColor = selectedMaterial.name.split(" ").pop();
      const body = {
        firstName: firstName.value.trim(),
        lastName: lastName.value.trim(),
        email: email.value.trim(),
        address: address.value.trim(),
        city: city.value.trim(),
        state: state.value.trim(),
        zip: zip.value.trim(),
        country: country.value.trim(),
        material: selectedMaterial.name,
        color: humanColor,
        infill: infillSlider.value,
        notes: notes.value,
        filename: file.name,
        volumeCm3: lastVolume,
        dims: lastDims,
        printer: lastPrinter.replace(/mm/g, "").trim(),
        price: parseFloat(costEl.textContent),
      };
      try {
        const res = await fetch("/api/stripe/create-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const json = await res.json();
        if (json.url) window.location.href = json.url;
        else {
          errorBox.textContent = json.error || "Stripe checkout failed.";
          errorBox.classList.remove("hidden");
        }
      } catch {
        errorBox.textContent = "Stripe request failed.";
        errorBox.classList.remove("hidden");
      }
    };

    showStep(0);
  </script>

  <!-- ================= STYLE ================= -->
  <style>
    .page {
      min-height: 100vh;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: radial-gradient(circle at 30% 20%, #0f1013, #060708 90%);
      padding: 7vh 1rem 4vh;
      box-sizing: border-box;
    }

    .card {
      margin: 6rem 0;
      width: min(95%, 60rem);
      background: rgba(19, 20, 25, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.03);
      border-radius: 1rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(10px);
      color: #fff;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: all 0.45s ease;
      animation: fadeInUp 0.5s ease both;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      text-align: center;
      padding: 1.8rem 1.2rem 1.2rem;
    }
    .card-header h1 {
      font-size: clamp(1.6rem, 3vw, 2rem);
      font-weight: 700;
    }
    .card-header p {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.55);
      margin-top: 0.3rem;
    }

    .progress-strip {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.06);
      position: relative;
      overflow: hidden;
      border-radius: 999px;
    }
    .progress-strip::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: var(--progress, 0%);
      background: linear-gradient(90deg, #3b82f6, #22c55e);
      border-radius: 999px;
      transition: width 0.45s ease;
    }

    .form {
      max-width: 52rem;
      width: 90%;
      margin: 0 auto;
      padding: 2.4rem 2rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.8rem;
      position: relative;
    }

    .step-indicator {
      text-align: center;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 0.5rem;
    }

    .step {
      opacity: 0;
      transform: translateX(25px);
      transition: all 0.35s ease;
      pointer-events: none;
      visibility: hidden;
      position: absolute;
      width: 100%;
    }
    .step.active {
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
      visibility: visible;
      position: relative;
    }

    .form-inner {
      width: 90%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }
    .form-inner.wide {
      width: 90%;
      max-width: 64rem;
    }

    .row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .row.two > .field {
      flex: 1 1 0;
    }
    .row.full > .field {
      width: 100%;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .field label {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .input,
    .fileinput,
    textarea {
      background: #16171b;
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 0.5rem;
      padding: 0.6rem 0.9rem;
      font-size: 0.92rem;
      color: #fff;
      outline: none;
      transition: all 0.25s ease;
      width: 100%;
      box-sizing: border-box;
    }
    .input:focus,
    textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.18);
    }

    .fileinput {
      border: 2px dashed rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.01);
      text-align: center;
      cursor: pointer;
      padding: 1.3rem 0.8rem;
      font-size: 0.9rem;
      transition: all 0.25s ease;
    }
    .fileinput:hover {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.05);
    }
    .fileinput::file-selector-button {
      display: none;
    }

    .note {
      font-size: 0.65rem;
      color: rgba(255, 255, 255, 0.35);
    }

    /* === FILAMENT CAROUSEL (DESKTOP + MOBILE SCROLL FIX) === */
    /* ===== NEW RESPONSIVE FILAMENT CAROUSEL ===== */
    .filament-carousel {
      display: flex;
      gap: 0.8rem;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      overscroll-behavior-x: contain;
      padding: 0.8rem 0.4rem 0.9rem;
      margin: 0 -0.8rem;
      touch-action: pan-x;
      user-select: none;
    }

    .filament-carousel::-webkit-scrollbar {
      display: none;
    }

    .filament-chip {
      flex: 0 0 auto;
      scroll-snap-align: center;
      min-width: 135px;
      max-width: 180px;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.55rem 0.9rem;
      border-radius: 0.6rem;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      color: #fff;
      font-size: 0.8rem;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    .filament-chip:hover {
      background: rgba(59, 130, 246, 0.08);
      border-color: rgba(59, 130, 246, 0.4);
    }
    .filament-chip.active {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.18);
      box-shadow: 0 0 8px rgba(59, 130, 246, 0.35);
    }

    .chip-color {
      width: 1.2rem;
      height: 1.2rem;
      border-radius: 0.3rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .step-2,
    .form-inner.wide,
    .row.full,
    .form {
      overflow: visible !important;
    }

    /* === VIEWER / PRICE SECTIONS === */
    .viewer-title {
      text-align: center;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .viewer {
      width: 100%;
      background: #d9dadb;
      border-radius: 0.6rem;
      overflow: hidden;
      aspect-ratio: 1/1;
      position: relative;
    }
    .viewer canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    .loading {
      position: absolute;
      inset: 0;
      display: none;
      background: rgba(0, 0, 0, 0.05);
      place-items: center;
      color: #000;
      font-weight: 500;
    }

    .size-line {
      text-align: center;
      font-size: 0.78rem;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 0.4rem;
    }

    .price-line {
      text-align: center;
      margin-top: 0.6rem;
    }
    .price {
      color: #22c55e;
      font-weight: 600;
    }
    .breakdown {
      text-align: center;
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.45);
      margin-top: 0.3rem;
    }

    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.8rem;
      margin-top: 2rem;
    }
    .btn {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.03);
      border-radius: 0.45rem;
      color: #fff;
      font-size: 0.85rem;
      padding: 0.6rem 1.4rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
    }
    .btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .btn.primary {
      background: #3b82f6;
    }
    .btn.success {
      background: #22c55e;
    }

    .error {
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: #f87171;
    }
    .hidden {
      display: none;
    }

    /* === STEP 1 WIDER === */
    .step-1 .form-inner {
      width: 90%;
      max-width: 64rem;
    }
    /* === MOBILE RESPONSIVE === */
    /* === MOBILE PORTRAIT FIX: ENABLE TRUE HORIZONTAL SCROLL === */
    @media (max-width: 768px) {
      .form {
        width: 95%;
        max-width: 64rem;
        padding: 1.6rem 1rem 1.6rem !important;
        margin: 0 !important;
        overflow: visible !important;
        contain: none !important;
      }
      /* Make steps static so nested scroll zones receive touch events */
      .step {
        position: relative !important;
        overflow: visible !important;
        transform: none !important;
      }

      .form,
      .form-inner,
      .form-inner.wide,
      .step-2,
      .row.full {
        overflow: visible !important;
        contain: none !important;
        transform: none !important;
      }

      /* Dedicated scroll zone for carousel */
      .filament-carousel {
        display: flex;
        flex-wrap: nowrap;
        gap: 0.6rem;
        padding: 0.7rem 0.3rem 0.8rem;
        overflow-x: scroll !important;
        overflow-y: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        scroll-snap-type: x proximity !important;
        overscroll-behavior-x: contain !important;
        touch-action: pan-x !important;
        user-select: none !important;
        pointer-events: all !important;
        position: relative !important;
        z-index: 10 !important;
      }

      .filament-carousel::-webkit-scrollbar {
        display: none;
      }

      /* Each filament chip remains scroll-snap aligned */
      .filament-chip {
        flex: 0 0 auto;
        scroll-snap-align: center;
        min-width: 120px;
        font-size: 0.75rem;
        padding: 0.5rem 0.7rem;
      }

      /* Body and html remain scrollable vertically */
      html,
      body {
        touch-action: pan-y !important;
        overscroll-behavior: contain !important;
      }
    }
  </style>
</Layout>
