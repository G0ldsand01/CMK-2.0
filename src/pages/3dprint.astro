---
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import Layout from "../layouts/Layout.astro";
---
<Layout title="3D Print Quote Service" navbar={true}>
  <main class="max-w-6xl mx-auto px-4 py-8 mt-25">
    <div class="space-y-6">
      {/* Header */}
      <div class="text-center space-y-2">
        <h1 class="text-4xl font-bold tracking-tight">3D Print Quote Service</h1>
        <p class="text-muted-foreground text-lg">
          Upload your model, select filament, and get an instant estimate.
        </p>
      </div>

      <Card className="shadow-lg">
        <CardHeader>
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
              <CardTitle className="text-2xl">3D Printing Quote</CardTitle>
              <CardDescription id="step-label" className="mt-1">Step 1 of 3 — Customer Info</CardDescription>
            </div>
            <div class="w-full sm:w-64 h-2 bg-muted rounded-full overflow-hidden">
              <div class="h-full bg-primary transition-all duration-500" id="progress-strip" style="width: 33.33%"></div>
            </div>
          </div>
        </CardHeader>
        <CardContent className="pt-6">
          <p id="error-box" class="text-destructive text-sm mb-4 hidden bg-destructive/10 p-3 rounded-md border border-destructive/20"></p>

          <form id="quote-form" class="space-y-6">
            <!-- ================= STEP 1 ================= -->
            <section class="step step-1">
              <div class="space-y-5">
                <div class="grid gap-4 md:grid-cols-2">
                  <div class="space-y-2">
                    <Label htmlFor="firstName" className="text-sm font-semibold">First name *</Label>
                    <Input id="firstName" required className="h-10" />
                  </div>
                  <div class="space-y-2">
                    <Label htmlFor="lastName" className="text-sm font-semibold">Last name *</Label>
                    <Input id="lastName" required className="h-10" />
                  </div>
                </div>

                <div class="space-y-2">
                  <Label htmlFor="email" className="text-sm font-semibold">Email *</Label>
                  <Input id="email" type="email" required className="h-10" />
                </div>

                <div class="space-y-2">
                  <Label htmlFor="phone" className="text-sm font-semibold">Phone *</Label>
                  <Input
                    id="phone"
                    type="tel"
                    required
                    placeholder="+1 (555) 123-4567"
                    className="h-10"
                  />
                </div>

                <div class="space-y-2">
                  <Label htmlFor="address" className="text-sm font-semibold">Address *</Label>
                  <Input
                    id="address"
                    required
                    placeholder="Street number, road"
                    className="h-10"
                  />
                </div>

                <div class="grid gap-4 md:grid-cols-2">
                  <div class="space-y-2">
                    <Label htmlFor="city" className="text-sm font-semibold">City *</Label>
                    <Input id="city" required className="h-10" />
                  </div>
                  <div class="space-y-2">
                    <Label htmlFor="zip" className="text-sm font-semibold">Postal / ZIP *</Label>
                    <Input id="zip" required className="h-10" />
                  </div>
                </div>

                <div class="grid gap-4 md:grid-cols-2">
                  <div class="space-y-2">
                    <Label htmlFor="state" className="text-sm font-semibold">Province / State *</Label>
                    <Input id="state" required className="h-10" />
                  </div>
                  <div class="space-y-2">
                    <Label htmlFor="country" className="text-sm font-semibold">Country *</Label>
                    <Input id="country" value="Canada" required className="h-10" />
                  </div>
                </div>
              </div>
            </section>

            <!-- ================= STEP 2 ================= -->
            <section class="step step-2 hidden">
              <div class="space-y-6">
                <div class="space-y-2">
                  <Label htmlFor="modelFile">Upload 3D Model *</Label>
                  <Input
                    id="modelFile"
                    type="file"
                    accept=".stl,.3mf,.obj,.glb,.gltf,.fbx"
                    required
                  />
                  <p class="text-xs text-muted-foreground">Supports .stl, .3mf, .obj, .glb, .gltf, .fbx</p>
                </div>

                <!-- Filament Selection -->
                <div class="space-y-3">
                  <Label className="text-sm font-semibold">Material & Color *</Label>
                  <div id="filament-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3">
                    <!-- PLA Colors -->
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-primary bg-primary/10 text-sm font-medium transition-all hover:scale-105 hover:shadow-md cursor-pointer"
                      data-name="PLA Basic White"
                      data-color="#f5f5f5"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#f5f5f5"></span>
                      <span class="text-xs text-center font-medium">PLA White</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PLA Basic Black"
                      data-color="#1a1a1a"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#1a1a1a"></span>
                      <span class="text-xs text-center font-medium">PLA Black</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PLA Basic Gray"
                      data-color="#7d7d7d"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#7d7d7d"></span>
                      <span class="text-xs text-center font-medium">PLA Gray</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PLA Basic Blue"
                      data-color="#004fce"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#004fce"></span>
                      <span class="text-xs text-center font-medium">PLA Blue</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PLA Basic Red"
                      data-color="#bb2b2b"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#bb2b2b"></span>
                      <span class="text-xs text-center font-medium">PLA Red</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PLA Basic Green"
                      data-color="#108b1b"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#108b1b"></span>
                      <span class="text-xs text-center font-medium">PLA Green</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PLA Basic Yellow"
                      data-color="#fbbf24"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#fbbf24"></span>
                      <span class="text-xs text-center font-medium">PLA Yellow</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PLA Basic Orange"
                      data-color="#f97316"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#f97316"></span>
                      <span class="text-xs text-center font-medium">PLA Orange</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PLA Basic Purple"
                      data-color="#9333ea"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#9333ea"></span>
                      <span class="text-xs text-center font-medium">PLA Purple</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PLA Basic Pink"
                      data-color="#ec4899"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#ec4899"></span>
                      <span class="text-xs text-center font-medium">PLA Pink</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PLA Basic Brown"
                      data-color="#92400e"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#92400e"></span>
                      <span class="text-xs text-center font-medium">PLA Brown</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PLA Basic Cyan"
                      data-color="#06b6d4"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#06b6d4"></span>
                      <span class="text-xs text-center font-medium">PLA Cyan</span>
                    </button>
                    <!-- PETG Colors -->
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PETG Transparent"
                      data-color="#d0d6dc"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#d0d6dc"></span>
                      <span class="text-xs text-center font-medium">PETG Clear</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PETG Blue"
                      data-color="#2563eb"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#2563eb"></span>
                      <span class="text-xs text-center font-medium">PETG Blue</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="PETG Black"
                      data-color="#0f172a"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#0f172a"></span>
                      <span class="text-xs text-center font-medium">PETG Black</span>
                    </button>
                    <!-- ABS Colors -->
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="ABS Black"
                      data-color="#111"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#111"></span>
                      <span class="text-xs text-center font-medium">ABS Black</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="ABS White"
                      data-color="#f8f9fa"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#f8f9fa"></span>
                      <span class="text-xs text-center font-medium">ABS White</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="ABS Red"
                      data-color="#dc2626"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#dc2626"></span>
                      <span class="text-xs text-center font-medium">ABS Red</span>
                    </button>
                    <!-- TPU Colors -->
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="TPU Transparent"
                      data-color="#e0e0e0"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#e0e0e0"></span>
                      <span class="text-xs text-center font-medium">TPU Clear</span>
                    </button>
                    <button
                      type="button"
                      class="filament-chip flex flex-col items-center gap-2 p-3 rounded-lg border-2 border-input bg-background text-sm font-medium transition-all hover:scale-105 hover:shadow-md hover:border-primary/50 cursor-pointer"
                      data-name="TPU Black"
                      data-color="#1f2937"
                    >
                      <span class="w-10 h-10 rounded-full border-2 border-foreground/20 shadow-md" style="background:#1f2937"></span>
                      <span class="text-xs text-center font-medium">TPU Black</span>
                    </button>
                  </div>
                </div>

                <div class="space-y-2">
                  <Label htmlFor="infill">Infill (%)</Label>
                  <div class="flex items-center gap-4">
                    <input
                      id="infill"
                      type="range"
                      min="0"
                      max="100"
                      value="15"
                      class="flex-1 h-2 bg-muted rounded-lg appearance-none cursor-pointer accent-primary"
                    />
                    <span id="infill-value" class="text-sm font-medium w-12 text-center">15%</span>
                  </div>
                  <p class="text-xs text-muted-foreground">
                    15–25 % is good for most cosmetic / functional parts.
                  </p>
                </div>

                <div class="space-y-2">
                  <Label htmlFor="notes">Notes / special instructions</Label>
                  <Textarea
                    id="notes"
                    rows="3"
                    placeholder="Ex : color brand, supports, orientation..."
                  />
                </div>
              </div>
            </section>

            <!-- ================= STEP 3 ================= -->
            <section class="step step-3 hidden">
              <div class="space-y-6">
                <div class="text-center space-y-3">
                  <h2 class="text-2xl font-bold">Model Preview</h2>
                  <div class="inline-flex items-center gap-2 px-4 py-2 bg-primary/10 rounded-lg border border-primary/20">
                    <span class="text-muted-foreground">Estimated cost:</span>
                    <span id="cost" class="text-primary font-bold text-xl">0.00 $</span>
                  </div>
                  <div id="cost-breakdown" class="text-sm text-muted-foreground mt-2"></div>
                </div>
                
                <div class="space-y-4">
                  <div class="flex items-center justify-center gap-4 flex-wrap">
                    <button id="center-model-btn" type="button" class="inline-flex items-center justify-center gap-2 rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50" title="Center model on bed">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="2" x2="12" y2="6"></line>
                        <line x1="12" y1="18" x2="12" y2="22"></line>
                        <line x1="2" y1="12" x2="6" y2="12"></line>
                        <line x1="18" y1="12" x2="22" y2="12"></line>
                      </svg>
                      Center on Bed
                    </button>
                    <label class="flex items-center gap-2 cursor-pointer px-3 py-2 rounded-md border border-input hover:bg-accent transition-colors">
                      <input type="checkbox" id="toggle-ruler" checked class="h-4 w-4 rounded border-input accent-primary" />
                      <span class="text-sm font-medium">Show Ruler</span>
                    </label>
                  </div>
                  
                  <div class="relative w-full bg-muted rounded-lg overflow-hidden aspect-square border border-border shadow-inner">
                    <div id="loading" class="absolute inset-0 flex items-center justify-center bg-muted/80 backdrop-blur-sm z-20 hidden">
                      <div class="flex flex-col items-center gap-2">
                        <div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-sm font-medium text-foreground">Loading model...</span>
                      </div>
                    </div>
                    <canvas id="stl-canvas" class="w-full h-full"></canvas>
                    <div id="ruler-overlay" class="absolute inset-0 pointer-events-none z-10"></div>
                  </div>
                </div>

                <div class="text-center p-3 bg-muted/50 rounded-lg border border-border">
                  <p id="size-line" class="text-sm font-medium text-foreground">
                    Detected size: —
                  </p>
                </div>
              </div>
            </section>

            <!-- ACTIONS -->
            <div class="flex justify-between gap-4 pt-6 border-t">
              <button id="prev-btn" type="button" class="inline-flex items-center justify-center rounded-md bg-secondary px-4 py-2 text-sm font-medium text-secondary-foreground shadow-sm transition-colors hover:bg-secondary/80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Previous
              </button>
              <button id="next-btn" type="button" class="inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50">
                Next
              </button>
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  </main>

  <!-- ================= SCRIPT ================= -->
  <script type="module">
    import * as THREE from "https://esm.sh/three@0.160.0";
    import { OrbitControls } from "https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { STLLoader } from "https://esm.sh/three@0.160.0/examples/jsm/loaders/STLLoader.js";

    const steps = [...document.querySelectorAll(".step")];
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const strip = document.getElementById("progress-strip");
    const fileInput = document.getElementById("modelFile");
    const errorBox = document.getElementById("error-box");
    const canvas = document.getElementById("stl-canvas");
    const loading = document.getElementById("loading");
    const sizeLine = document.getElementById("size-line");
    const costEl = document.getElementById("cost");
    const breakdown = document.getElementById("cost-breakdown");
    const filamentGrid = document.getElementById("filament-grid");
    const infillSlider = document.getElementById("infill");
    const infillValue = document.getElementById("infill-value");

    // form fields
    const firstName = document.getElementById("firstName");
    const lastName = document.getElementById("lastName");
    const email = document.getElementById("email");
    const phone = document.getElementById("phone");
    const address = document.getElementById("address");
    const city = document.getElementById("city");
    const state = document.getElementById("state");
    const zip = document.getElementById("zip");
    const country = document.getElementById("country");
    const notes = document.getElementById("notes");

    let step = 0;
    let file = null;
    let scene, camera, renderer, controls, mesh, bed, bedHelper;
    let lastVolume = 0;
    let lastDims = { x: 0, y: 0, z: 0 };
    let lastPrinter = "Unknown size";
    let selectedMaterial = { name: "PLA Basic White", color: "#f5f5f5" };
    let bedSize = { x: 220, y: 220, z: 250 }; // Default bed size (Ender 3)
    const centerModelBtn = document.getElementById("center-model-btn");
    const toggleRuler = document.getElementById("toggle-ruler");
    const rulerOverlay = document.getElementById("ruler-overlay");

    /* === STEP NAVIGATION === */
    function setProgress(i) {
      const pct = ((i + 1) / steps.length) * 100;
      strip.style.width = pct + "%";
    }

    function showStep(i) {
      steps.forEach((s, idx) => {
        if (idx === i) {
          s.classList.add("active");
          s.classList.remove("hidden");
        } else {
          s.classList.remove("active");
          s.classList.add("hidden");
        }
      });
      step = i;
      const stepLabelEl = document.getElementById("step-label");
      if (stepLabelEl) {
        stepLabelEl.textContent =
          i === 0
            ? "Step 1 of 3 — Customer Info"
            : i === 1
              ? "Step 2 of 3 — Print Details"
              : "Step 3 of 3 — Preview & Checkout";
      }
      
      // Button logic:
      // Step 1: Previous disabled, Next enabled
      // Step 2: Previous enabled, Next enabled
      // Step 3: Previous enabled, Next becomes "Checkout"
      
      prevBtn.disabled = i === 0;
      
      if (i === steps.length - 1) {
        // Last step: change Next button to Checkout
        nextBtn.textContent = "Checkout";
      } else {
        // Not last step: show Next
        nextBtn.textContent = "Next";
      }
      
      setProgress(i);
      if (i === 2 && file) loadModel(file);
    }

    function validate(i) {
      errorBox.classList.add("hidden");
      if (i === 0) {
        const ids = [
          "firstName",
          "lastName",
          "email",
          "phone",
          "address",
          "city",
          "state",
          "zip",
          "country",
        ];
        for (const id of ids) {
          const el = document.getElementById(id);
          if (!el.value.trim()) {
            errorBox.textContent = "Please fill all required fields.";
            errorBox.classList.remove("hidden");
            return false;
          }
        }
      }
      if (i === 1 && !fileInput.files.length) {
        errorBox.textContent = "Please upload a model.";
        errorBox.classList.remove("hidden");
        return false;
      }
      return true;
    }

    prevBtn.onclick = () => {
      if (step > 0) showStep(step - 1);
    };
    
    nextBtn.onclick = async () => {
      // If on last step, do checkout
      if (step === steps.length - 1) {
        await handleCheckout();
      } else {
        // Otherwise, go to next step
        if (validate(step)) {
          showStep(step + 1);
        }
      }
    };

    /* === FILAMENT SELECTION === */
    filamentGrid.querySelectorAll(".filament-chip").forEach((chip) => {
      chip.addEventListener("click", () => {
        // Remove active state from all chips
        filamentGrid.querySelectorAll(".filament-chip").forEach((c) => {
          c.classList.remove("border-primary", "bg-primary/10");
          c.classList.add("border-input", "bg-background");
        });
        // Add active state to clicked chip
        chip.classList.add("border-primary", "bg-primary/10");
        chip.classList.remove("border-input", "bg-background");
        selectedMaterial = {
          name: chip.dataset.name || "PLA Basic White",
          color: chip.dataset.color || "#f5f5f5",
        };
        if (mesh) mesh.material.color.set(selectedMaterial.color);
        if (lastVolume) updateEstimate();
      });
    });

    /* === INFILL SLIDER === */
    infillSlider.addEventListener("input", () => {
      infillValue.textContent = infillSlider.value + "%";
      if (lastVolume) updateEstimate();
    });

    /* === FILE HANDLER === */
    fileInput.onchange = (e) => {
      file = e.target.files[0];
      if (step === 2 && file) loadModel(file);
    };

    /* === COST ESTIMATION === */
    function updateEstimate() {
      const est = estimateCost(
        lastVolume,
        selectedMaterial.name,
        Number(infillSlider.value),
        lastDims
      );

      // Add handling time (0.5h setup + real-life 24h post-print delay)
      const handlingTimeHours = 0.5;
      const postProcessingDelayHours = 24;
      const totalPrintTime = est.timeHours + handlingTimeHours;

      // Human-readable print time
      const hrs = Math.floor(totalPrintTime);
      const mins = Math.round((totalPrintTime - hrs) * 60);
      const timeText = hrs > 0 ? `${hrs}h ${mins}min` : `${mins}min`;

      // Human-readable total completion estimate
      const completionDate = new Date();
      completionDate.setHours(
        completionDate.getHours() + postProcessingDelayHours
      );
      const options = { weekday: "short", hour: "2-digit", minute: "2-digit" };
      const formattedCompletion = completionDate.toLocaleString([], options);

      // Display only what’s relevant to the user
      costEl.textContent = est.total.toFixed(2) + " $";
      const setupFeeText = est.setupFee ? ` • Setup fee: $${est.setupFee.toFixed(2)} (based on model size)` : '';
      breakdown.textContent = `Estimated print time: ${timeText} ⏱️ 
  • Ready for shipping or pickup after ${formattedCompletion} (Time may vary depending on your location and demand).${setupFeeText}`;
    }

    /* === THREE.JS MODEL LOADING === */
    function initThree() {
      if (renderer) return;
      renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setClearColor(0xd9dadb, 1);
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(
        60,
        canvas.clientWidth / canvas.clientHeight,
        0.1,
        1000
      );
      camera.position.set(0, 0, 120);
      const ambient = new THREE.AmbientLight(0xffffff, 0.9);
      const dir = new THREE.DirectionalLight(0xffffff, 1);
      dir.position.set(3, 2, 5);
      scene.add(ambient, dir);
      
      // Create print bed
      createPrintBed();
      
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.target.set(0, 0, 0);
      
      const loop = () => {
        requestAnimationFrame(loop);
        controls.update();
        updateRuler();
        renderer.render(scene, camera);
      };
      loop();
    }

    function createPrintBed() {
      if (bed) {
        scene.remove(bed);
        if (bedHelper) scene.remove(bedHelper);
      }
      
      // Create bed plane
      const bedGeometry = new THREE.PlaneGeometry(bedSize.x, bedSize.y);
      const bedMaterial = new THREE.MeshStandardMaterial({
        color: 0x2a2a2a,
        roughness: 0.8,
        metalness: 0.1,
        side: THREE.DoubleSide,
      });
      bed = new THREE.Mesh(bedGeometry, bedMaterial);
      bed.rotation.x = -Math.PI / 2;
      bed.position.y = 0;
      scene.add(bed);
      
      // Add bed grid helper
      bedHelper = new THREE.GridHelper(
        Math.max(bedSize.x, bedSize.y),
        20,
        0x444444,
        0x666666
      );
      bedHelper.position.y = 0.1;
      scene.add(bedHelper);
    }

    function centerModelOnBed() {
      if (!mesh) return;
      
      const box = new THREE.Box3().setFromObject(mesh);
      const size = new THREE.Vector3();
      box.getSize(size);
      const center = new THREE.Vector3();
      box.getCenter(center);
      
      // Center model horizontally (x and z) and place bottom on bed (y=0)
      const offset = new THREE.Vector3(
        -center.x,  // Center X
        -box.min.y, // Place bottom on bed (y=0)
        -center.z   // Center Z
      );
      mesh.position.copy(offset);
      
      // Update camera to view centered model
      const maxDim = Math.max(size.x, size.y, size.z);
      const modelHeight = size.y;
      camera.position.set(maxDim * 1.3, modelHeight * 0.6, maxDim * 1.5);
      controls.target.set(0, modelHeight / 2, 0);
      controls.update();
    }

    function updateRuler() {
      if (!mesh || !rulerOverlay) return;
      
      if (!toggleRuler || !toggleRuler.checked) {
        rulerOverlay.style.display = "none";
        return;
      }
      
      rulerOverlay.style.display = "block";
      
      // Get model bounding box
      const box = new THREE.Box3().setFromObject(mesh);
      const size = new THREE.Vector3();
      box.getSize(size);
      
      // Project model center to screen
      const center = new THREE.Vector3();
      box.getCenter(center);
      center.project(camera);
      
      const x = (center.x * 0.5 + 0.5) * canvas.clientWidth;
      const y = (center.y * -0.5 + 0.5) * canvas.clientHeight;
      
      // Create ruler HTML with dimensions
      const rulerHtml = `
        <div class="ruler-x" style="left: ${x}px; top: ${y}px;">
          <div class="ruler-label">X: ${size.x.toFixed(1)}mm</div>
          <div class="ruler-line"></div>
        </div>
        <div class="ruler-y" style="left: ${x}px; top: ${y}px;">
          <div class="ruler-label">Y: ${size.y.toFixed(1)}mm</div>
          <div class="ruler-line"></div>
        </div>
        <div class="ruler-z" style="left: ${x}px; top: ${y}px;">
          <div class="ruler-label">Z: ${size.z.toFixed(1)}mm</div>
          <div class="ruler-line"></div>
        </div>
      `;
      rulerOverlay.innerHTML = rulerHtml;
    }

    async function loadModel(file) {
      initThree();
      //viewerStatus.textContent = "Loading model...";
      loading.style.display = "grid";
      if (mesh) {
        scene.remove(mesh);
        mesh.geometry.dispose();
      }
      const loader = new STLLoader();
      const buf = await file.arrayBuffer();
      const geometry = loader.parse(buf);
      geometry.computeBoundingBox();
      const material = new THREE.MeshStandardMaterial({
        color: selectedMaterial.color || "#cccccc",
        roughness: 0.6,
        metalness: 0.1,
      });
      mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);
      
      // Calculate dimensions and center on bed
      const box = new THREE.Box3().setFromObject(mesh);
      const size = new THREE.Vector3();
      box.getSize(size);
      
      // Center model on bed
      centerModelOnBed();

      lastDims = {
        x: Number(size.x.toFixed(1)),
        y: Number(size.y.toFixed(1)),
        z: Number(size.z.toFixed(1)),
      };
      if (size.x <= 180 && size.y <= 180 && size.z <= 180) {
        lastPrinter = "A1 Mini (180×180×180)";
        bedSize = { x: 180, y: 180, z: 180 };
      } else if (size.x <= 220 && size.y <= 220 && size.z <= 220) {
        lastPrinter = "Ender 3 (220×220×220)";
        bedSize = { x: 220, y: 220, z: 220 };
      } else if (size.x <= 256 && size.y <= 256 && size.z <= 256) {
        lastPrinter = "Bambu A1 (256×256×256)";
        bedSize = { x: 256, y: 256, z: 256 };
      } else {
        lastPrinter = "Too large / custom";
        bedSize = { x: 300, y: 300, z: 300 }; // Default large bed
      }
      
      // Update bed size
      createPrintBed();
      
      // Center model on bed automatically
      setTimeout(() => {
        centerModelOnBed();
        updateRuler();
      }, 100);

      sizeLine.textContent = `Detected size: ${lastDims.x} × ${lastDims.y} × ${lastDims.z} mm — Printer: ${lastPrinter}`;
      const vol = calcVolume(geometry);
      lastVolume = vol;
      updateEstimate();
      //viewerStatus.textContent = "Model loaded.";
      loading.style.display = "none";
    }

    function calcVolume(geometry) {
      const pos = geometry.attributes.position.array;
      let volume = 0;
      for (let i = 0; i < pos.length; i += 9) {
        const ax = pos[i],
          ay = pos[i + 1],
          az = pos[i + 2];
        const bx = pos[i + 3],
          by = pos[i + 4],
          bz = pos[i + 5];
        const cx = pos[i + 6],
          cy = pos[i + 7],
          cz = pos[i + 8];
        volume +=
          (ax * (by * cz - bz * cy) -
            ay * (bx * cz - bz * cx) +
            az * (bx * cy - by * cx)) /
          6;
      }
      return Math.abs(volume) / 1000;
    }

    function estimateCost(vol, mat, infill, dims) {
      let p = { density: 1.24, pricePerKg: 25 };
      if (mat.includes("PETG")) p = { density: 1.27, pricePerKg: 30 };
      if (mat.includes("ABS")) p = { density: 1.04, pricePerKg: 28 };
      if (mat.includes("TPU")) p = { density: 1.2, pricePerKg: 35 };
      const infillFactor = 0.6 + (infill || 15) / 200;
      const speed = 25;
      const grams = vol * p.density * infillFactor;
      const materialCost = (grams / 1000) * p.pricePerKg;
      const timeHours = (vol / speed) * infillFactor;
      const timeCost = timeHours * 3.5;
      const energyCost = (0.12 * 120 * timeHours) / 1000;
      
      // Base cost calculation
      const baseCost = materialCost + timeCost + energyCost;
      
      // Add overhead (setup, post-processing, packaging, handling)
      const overhead = baseCost * 0.20; // 20% for setup, post-processing, packaging
      
      // Proportional setup fee based on model size (volume in cm³)
      // Small models (< 10 cm³): $5 base fee
      // Medium models (10-50 cm³): $5 + $0.50 per cm³ above 10
      // Large models (> 50 cm³): $25 + $0.30 per cm³ above 50
      let setupFee = 0;
      if (vol < 10) {
        setupFee = 5.00;
      } else if (vol <= 50) {
        setupFee = 5.00 + (vol - 10) * 0.50;
      } else {
        setupFee = 25.00 + (vol - 50) * 0.30;
      }
      
      // Calculate total with profit margin (2.5x markup for better profit)
      let total = (baseCost + overhead) * 2.5;
      
      // Add proportional setup fee
      total += setupFee;
      
      // Ensure minimum Stripe requirement (0.50 CAD)
      const STRIPE_MINIMUM = 0.50;
      if (total < STRIPE_MINIMUM) {
        total = STRIPE_MINIMUM;
      }
      
      return { materialCost, timeHours, energyCost, setupFee, total };
    }

    /* === CHECKOUT === */
    async function handleCheckout() {
      // Validate all steps
      if (!validate(0) || !validate(1) || !file) {
        // Go to first invalid step
        if (!validate(0)) showStep(0);
        else if (!validate(1)) showStep(1);
        return;
      }
      
      nextBtn.disabled = true;
      nextBtn.textContent = "Uploading file...";
      errorBox.classList.add("hidden");
      
      try {
        // First, upload the file to CDN
        const formData = new FormData();
        formData.append("file", file);
        
        const uploadRes = await fetch("/api/3dprint/upload", {
          method: "POST",
          body: formData,
        });
        
        const uploadJson = await uploadRes.json();
        
        if (!uploadJson.success || !uploadJson.url) {
          errorBox.textContent = uploadJson.error || "Failed to upload file.";
          errorBox.classList.remove("hidden");
          nextBtn.disabled = false;
          nextBtn.textContent = "Checkout";
          return;
        }
        
        // File uploaded successfully, now create Stripe session
        nextBtn.textContent = "Creating checkout...";
        
        const humanColor = selectedMaterial.name.split(" ").pop();
        const body = {
          firstName: firstName.value.trim(),
          lastName: lastName.value.trim(),
          email: email.value.trim(),
          phone: phone.value.trim(),
          address: address.value.trim(),
          city: city.value.trim(),
          state: state.value.trim(),
          zip: zip.value.trim(),
          country: country.value.trim(),
          material: selectedMaterial.name,
          color: humanColor,
          infill: infillSlider.value,
          notes: notes.value,
          filename: file.name,
          filesize: file.size,
          volumeCm3: lastVolume,
          dims: lastDims,
          printer: lastPrinter.replace(/mm/g, "").trim(),
          price: parseFloat(costEl.textContent),
          fileUrl: uploadJson.url, // Add the uploaded file URL
        };
        
        const res = await fetch("/api/stripe/create-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        
        const json = await res.json();
        if (json.url) {
          window.location.href = json.url;
        } else {
          errorBox.textContent = json.error || "Stripe checkout failed.";
          errorBox.classList.remove("hidden");
          nextBtn.disabled = false;
          nextBtn.textContent = "Checkout";
        }
      } catch (err) {
        errorBox.textContent = err instanceof Error ? err.message : "Request failed.";
        errorBox.classList.remove("hidden");
        nextBtn.disabled = false;
        nextBtn.textContent = "Checkout";
      }
    }

      // Center model button
      if (centerModelBtn) {
        centerModelBtn.onclick = () => {
          centerModelOnBed();
          updateRuler();
        };
      }
      
      // Toggle ruler
      if (toggleRuler) {
        toggleRuler.addEventListener("change", () => {
          updateRuler();
        });
      }
      
      // Handle window resize
      window.addEventListener("resize", () => {
        if (renderer && camera) {
          camera.aspect = canvas.clientWidth / canvas.clientHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        }
      });

      // Initialize buttons state on page load
      prevBtn.disabled = true;
      nextBtn.textContent = "Next";
      
      showStep(0);
  </script>

  <!-- ================= STYLE ================= -->
  <style>
    .ruler-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }
    .ruler-x,
    .ruler-y,
    .ruler-z {
      position: absolute;
      pointer-events: none;
    }
    .ruler-x {
      transform: translate(-50%, -50%);
    }
    .ruler-x .ruler-line {
      width: 2px;
      height: 60px;
      background: hsl(var(--primary));
      margin: 0 auto;
      box-shadow: 0 0 4px hsl(var(--primary) / 0.8);
    }
    .ruler-y {
      transform: translate(-50%, -50%) rotate(90deg);
    }
    .ruler-y .ruler-line {
      width: 2px;
      height: 60px;
      background: #10b981;
      margin: 0 auto;
      box-shadow: 0 0 4px rgba(16, 185, 129, 0.8);
    }
    .ruler-z {
      transform: translate(-50%, -50%) rotate(45deg);
    }
    .ruler-z .ruler-line {
      width: 2px;
      height: 60px;
      background: #f59e0b;
      margin: 0 auto;
      box-shadow: 0 0 4px rgba(245, 158, 11, 0.8);
    }
    .ruler-label {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      white-space: nowrap;
      font-weight: 600;
    }

    .step {
      display: none;
    }
    .step.active {
      display: block;
    }



    /* === VIEWER === */
    #loading {
      z-index: 10;
    }
    .ruler-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }
    .ruler-x,
    .ruler-y,
    .ruler-z {
      position: absolute;
      pointer-events: none;
    }
    .ruler-x {
      transform: translate(-50%, -50%);
    }
    .ruler-x .ruler-line {
      width: 2px;
      height: 60px;
      background: #3b82f6;
      margin: 0 auto;
      box-shadow: 0 0 4px rgba(59, 130, 246, 0.8);
    }
    .ruler-y {
      transform: translate(-50%, -50%) rotate(90deg);
    }
    .ruler-y .ruler-line {
      width: 2px;
      height: 60px;
      background: #10b981;
      margin: 0 auto;
      box-shadow: 0 0 4px rgba(16, 185, 129, 0.8);
    }
    .ruler-z {
      transform: translate(-50%, -50%) rotate(45deg);
    }
    .ruler-z .ruler-line {
      width: 2px;
      height: 60px;
      background: #f59e0b;
      margin: 0 auto;
      box-shadow: 0 0 4px rgba(245, 158, 11, 0.8);
    }
    .ruler-label {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      white-space: nowrap;
      font-weight: 600;
    }

  </style>
</Layout>
